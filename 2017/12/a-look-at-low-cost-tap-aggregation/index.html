<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Damian Zaremba - A look at low-cost tap aggregation</title>

    <!-- General meta data -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <meta name="google-site-verification" content="qykIg-4DghoGe78ET4eRjKG1cx6n3gXvu4jF0FvcwRo" />
    <meta name="author" content="Damian Zaremba" />
    <link rel="alternate" type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba" />

    <!-- Robot meta data -->
    <meta name="robots" content="INDEX" />
    <meta name="robots" content="FOLLOW" />
    <meta name="robots" content="INDEX,FOLLOW" />

    <!-- CSS files -->
    <link href="/assests/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assests/css/main.css" rel="stylesheet">

    <!--
    RIPA NOTICE: No consent is given for the interception of this page transmission
    -->
  </head>
  <body>

    <!-- Header -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Damian Zaremba</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Blog</a></li>
            <li class=""><a href="/about/">About</a></li>
            <li class=""><a href="/cv/">CV</a></li>
            <li class=""><a href="/archive/">Archive</a></li>
            <li class=""><a href="/projects/">Projects</a></li>
          </ul>

          <div class="social-icons navbar-right visible-md visible-lg">
            <a href="https://twitter.com/DamianZaremba">
              <img class="twitter" src="/assests/images/twitter.png" alt="Twitter" />
            </a>
            <a href="https://github.com/DamianZaremba">
              <img class="github" src="/assests/images/github.png" alt="GitHub" />
            </a>
            <a href="https://feeds.feedburner.com/DamianZaremba">
              <img class="rss" src="/assests/images/rss.png" alt="RSS" />
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Page -->
    <div class="container">
<article class="post">
    <h1 class="title"><a href="/2017/12/a-look-at-low-cost-tap-aggregation/">A look at low-cost tap aggregation</a></h1>
    <div class="meta">
        <span><img src="/assests/images/date.png" title="Date" alt="Date" />25 Dec 2017</span>
        <span><img src="/assests/images/comments.png" title="Content" alt="Content" /><a href="/2017/12/a-look-at-low-cost-tap-aggregation/#disqus_thread">Comments</a></span>
        
            <ul class="categories">
            <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/python'>Python</a></li></ul>
        
    </div>
    <div class="entry">
        <p>A while ago, I had a project that required capturing traffic from a
number of sources, thus an adventure into possible solutions was born.</p>

<h2 id="why-do-we-want-to-capture-traffic">Why do we want to capture traffic?</h2>

<p>There are numerous reasons to capture traffic including:</p>

<ul>
  <li>Network troubleshooting</li>
  <li>Traffic monitoring (including intrusion detection)</li>
  <li>Legal requests/requirements</li>
</ul>

<p>Ultimately it’s about getting visibility, either for security or operations.</p>

<p>Our goal is given any path, to be able to replicate the traffic, with minimal impact.</p>

<h2 id="how-can-we-capture-traffic">How can we capture traffic?</h2>

<p>There are generally 3 different methods for capturing traffic, each with their
own complexities.</p>

<h3 id="from-a-target-device">From a target device</h3>
<p>At a basic level, a device can capture traffic in 2 ways:</p>

<ul>
  <li>‘CPU bound’; traffic that has been brought up the network stack and is ‘destined’ for this device</li>
  <li>Raw sockets; ‘raw’ network traffic that the device receives on a network interface.</li>
</ul>

<p>CPU bound traffic can be efficient to capture if filtered appropriately. When dealing with high
traffic volumes processing traffic can take critical resources away from your business applications.</p>

<p>Raw sockets are generally very limited, hub-based topologies are not widely used, limiting any traffic to broadcast for the servers subnet, or targeted (CPU bound) traffic (multicast/unicast).</p>

<p>Generally, to be usable by an analyser the traffic would need to be encapsulated and transmitted,
using further resources on the device.</p>

<h3 id="span-a-switch">Span a switch</h3>
<p>This is similar to inline, but I’ve separated it here due to implementation differences.</p>

<p>SPAN’s generally come in 3 forms:</p>

<ul>
  <li>SPAN - take traffic from port A, mirror to port B, on the same device</li>
  <li>RSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 2)</li>
  <li>ERSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 3)</li>
</ul>

<p>There are a number of downsides:</p>

<ul>
  <li>Vendors have varying levels of support;
    <ul>
      <li>RSPAN on a Juniper EX series switch doesn’t work over an AE</li>
      <li>Tricks can be used, for example, spanning into a GRE tunnel to accomplish ERSPAN, this becomes hardware dependent though</li>
    </ul>
  </li>
  <li>CPU generated (ICMP/ARP/LLDP/BPDU etc) packets generally do not get mirrored</li>
  <li>Invalid packets will not be seen (those dropped due to checksum errors for example)</li>
  <li>CPU usage can increase drastically due to extra processing requirements</li>
  <li>As we’re spanning in an L2 domain arp table churn can happen if you’re not careful</li>
</ul>

<p>However, if you need insight into a switched domain and don’t want to inline-tap every cable,
it might work for you.</p>

<h3 id="inline">Inline</h3>
<p>Inline-taps come in many different flavours, supporting different media types. At a basic level, there are 2 main differences.</p>

<h4 id="passive-tap">Passive tap</h4>
<ul>
  <li>Require no power, pass the original signal onto the output</li>
  <li>Reduce the output power by a known ratio (important when dealing with fibre)</li>
  <li>No monitoring data or other insights possible</li>
  <li>Very failure resistant</li>
</ul>

<h5 id="logical-operation">Logical operation</h5>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: passive tap Pages: 1 -->
<svg role="img" aria-label="passive tap" width="542pt" height="207pt" viewBox="0.00 0.00 542.00 206.95">
<title>passive tap</title>
<desc>digraph &quot;passive tap&quot; {

subgraph cluster_Input {
  label = &quot;Input Port&quot;;
    color = black;
  &quot;Input TX&quot;;
  &quot;Input RX&quot;;
}
subgraph cluster_Output {
  label = &quot;Output Port&quot;;
    color = black;
  &quot;Output TX&quot;;
  &quot;Output RX&quot;;
}
subgraph cluster_Monitor {
  label = &quot;Monitor Port&quot;;
    color = black;
  &quot;Monitor TX2&quot;;
  &quot;Monitor TX1&quot;;
}
&quot;Input TX&quot; -&gt; &quot;Output RX&quot;
&quot;Input TX&quot; -&gt; &quot;Monitor TX1&quot;
&quot;Output TX&quot; -&gt; &quot;Input RX&quot;
&quot;Output TX&quot; -&gt; &quot;Monitor TX2&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 202.95)">
<title>passive tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-202.95 538,-202.95 538,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_Input</title>
<polygon fill="none" stroke="black" points="8,-91 8,-166 248,-166 248,-91 8,-91" />
<text text-anchor="middle" x="128" y="-150.8" font-family="Times,serif" font-size="14.00">Input Port</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Output</title>
<polygon fill="none" stroke="black" points="256,-91 256,-166 526,-166 526,-91 256,-91" />
<text text-anchor="middle" x="391" y="-150.8" font-family="Times,serif" font-size="14.00">Output Port</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Monitor</title>
<polygon fill="none" stroke="black" points="164,-8 164,-83 474,-83 474,-8 164,-8" />
<text text-anchor="middle" x="319" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text>
</g>
<!-- Input TX -->
<g id="node1" class="node">
<title>Input TX</title>
<ellipse fill="none" stroke="black" cx="189" cy="-117" rx="50.89" ry="18" />
<text text-anchor="middle" x="189" y="-113.3" font-family="Times,serif" font-size="14.00">Input TX</text>
</g>
<!-- Output RX -->
<g id="node4" class="node">
<title>Output RX</title>
<ellipse fill="none" stroke="black" cx="324" cy="-117" rx="59.59" ry="18" />
<text text-anchor="middle" x="324" y="-113.3" font-family="Times,serif" font-size="14.00">Output RX</text>
</g>
<!-- Input TX&#45;&gt;Output RX -->
<g id="edge1" class="edge">
<title>Input TX&#45;&gt;Output RX</title>
<path fill="none" stroke="black" d="M239.89,-117C244.57,-117 249.26,-117 253.94,-117" />
<polygon fill="black" stroke="black" points="254.2,-120.5 264.2,-117 254.2,-113.5 254.2,-120.5" />
</g>
<!-- Monitor TX1 -->
<g id="node6" class="node">
<title>Monitor TX1</title>
<ellipse fill="none" stroke="black" cx="241" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="241" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text>
</g>
<!-- Input TX&#45;&gt;Monitor TX1 -->
<g id="edge2" class="edge">
<title>Input TX&#45;&gt;Monitor TX1</title>
<path fill="none" stroke="black" d="M199.77,-99.22C206.91,-88.1 216.4,-73.32 224.48,-60.73" />
<polygon fill="black" stroke="black" points="227.6,-62.35 230.06,-52.04 221.71,-58.56 227.6,-62.35" />
</g>
<!-- Input RX -->
<g id="node2" class="node">
<title>Input RX</title>
<ellipse fill="none" stroke="black" cx="68" cy="-117" rx="51.99" ry="18" />
<text text-anchor="middle" x="68" y="-113.3" font-family="Times,serif" font-size="14.00">Input RX</text>
</g>
<!-- Output TX -->
<g id="node3" class="node">
<title>Output TX</title>
<ellipse fill="none" stroke="black" cx="460" cy="-117" rx="58.49" ry="18" />
<text text-anchor="middle" x="460" y="-113.3" font-family="Times,serif" font-size="14.00">Output TX</text>
</g>
<!-- Output TX&#45;&gt;Input RX -->
<g id="edge3" class="edge">
<title>Output TX&#45;&gt;Input RX</title>
<path fill="none" stroke="black" d="M446.54,-134.62C432.85,-150.96 410,-174.18 384,-184 332.86,-203.32 188.73,-204.37 138,-184 117.19,-175.65 99.07,-157.82 86.48,-142.66" />
<polygon fill="black" stroke="black" points="89.03,-140.24 80.08,-134.59 83.55,-144.59 89.03,-140.24" />
</g>
<!-- Monitor TX2 -->
<g id="node5" class="node">
<title>Monitor TX2</title>
<ellipse fill="none" stroke="black" cx="397" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="397" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text>
</g>
<!-- Output TX&#45;&gt;Monitor TX2 -->
<g id="edge4" class="edge">
<title>Output TX&#45;&gt;Monitor TX2</title>
<path fill="none" stroke="black" d="M446.95,-99.22C438.08,-87.81 426.19,-72.54 416.25,-59.74" />
<polygon fill="black" stroke="black" points="418.94,-57.51 410.04,-51.76 413.41,-61.8 418.94,-57.51" />
</g>
</g>
</svg>
</div>

<p>There are different technologies for mirroring the payload when using copper, these
are generally resistor based, for fibre they’re either thin film or fused biconical taper based.</p>

<p><em>Note: Thin film is generally preferred for 40G+ links, due to their lower loss rate caused by more even light distribution.</em></p>

<p>The concept for all of them is the same:</p>

<ul>
  <li>Given an input of 100%</li>
  <li>Bleed off x% of the signal to the mirror port</li>
  <li>Pass the remaining 100-x% through to the output port</li>
</ul>

<p>A key consideration when using fibre is the ‘split ratio’ aka how much light to bleed off,
both the monitor and the output interfaces need enough light for the optics on the other end.</p>

<h4 id="active-tap">Active tap</h4>
<ul>
  <li>They require power and re-generate the output signals.</li>
  <li>Monitoring data can be provided (light levels etc)</li>
  <li>When using fibre there are no split ratio considerations</li>
</ul>

<h5 id="logical-operation-1">Logical operation</h5>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: active tap Pages: 1 -->
<svg role="img" aria-label="active tap" width="542pt" height="254pt" viewBox="0.00 0.00 542.00 254.00">
<title>active tap</title>
<desc>digraph &quot;active tap&quot; {

subgraph cluster_Input {
  label = &quot;Input Port&quot;;
    color = black;
  &quot;Input TX&quot;;
  &quot;Input RX&quot;;
}
subgraph cluster_Output {
  label = &quot;Output Port&quot;;
    color = black;
  &quot;Output TX&quot;;
  &quot;Output RX&quot;;
}
subgraph cluster_Monitor {
  label = &quot;Monitor Port&quot;;
    color = black;
  &quot;Monitor TX2&quot;;
  &quot;Monitor TX1&quot;;
}
subgraph cluster_Processor {
  color = black;
  shape = square;
  &quot;Processor&quot;;
}

&quot;Processor&quot; -&gt; &quot;Input TX&quot;
&quot;Input RX&quot; -&gt; &quot;Processor&quot;
&quot;Processor&quot; -&gt; &quot;Output TX&quot;
&quot;Output RX&quot; -&gt; &quot;Processor&quot;
&quot;Processor&quot; -&gt; &quot;Monitor TX1&quot;
&quot;Processor&quot; -&gt; &quot;Monitor TX2&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 250)">
<title>active tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-250 538,-250 538,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_Input</title>
<polygon fill="none" stroke="black" points="8,-163 8,-238 248,-238 248,-163 8,-163" />
<text text-anchor="middle" x="128" y="-222.8" font-family="Times,serif" font-size="14.00">Input Port</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Output</title>
<polygon fill="none" stroke="black" points="256,-163 256,-238 526,-238 526,-163 256,-163" />
<text text-anchor="middle" x="391" y="-222.8" font-family="Times,serif" font-size="14.00">Output Port</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Monitor</title>
<polygon fill="none" stroke="black" points="127,-8 127,-83 437,-83 437,-8 127,-8" />
<text text-anchor="middle" x="282" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_Processor</title>
<polygon fill="none" stroke="black" points="191,-91 191,-143 321,-143 321,-91 191,-91" />
</g>
<!-- Input TX -->
<g id="node1" class="node">
<title>Input TX</title>
<ellipse fill="none" stroke="black" cx="189" cy="-189" rx="50.89" ry="18" />
<text text-anchor="middle" x="189" y="-185.3" font-family="Times,serif" font-size="14.00">Input TX</text>
</g>
<!-- Input RX -->
<g id="node2" class="node">
<title>Input RX</title>
<ellipse fill="none" stroke="black" cx="68" cy="-189" rx="51.99" ry="18" />
<text text-anchor="middle" x="68" y="-185.3" font-family="Times,serif" font-size="14.00">Input RX</text>
</g>
<!-- Processor -->
<g id="node7" class="node">
<title>Processor</title>
<ellipse fill="none" stroke="black" cx="256" cy="-117" rx="56.59" ry="18" />
<text text-anchor="middle" x="256" y="-113.3" font-family="Times,serif" font-size="14.00">Processor</text>
</g>
<!-- Input RX&#45;&gt;Processor -->
<g id="edge2" class="edge">
<title>Input RX&#45;&gt;Processor</title>
<path fill="none" stroke="black" d="M99.86,-174.6C109.21,-170.76 119.48,-166.63 129,-163 155.41,-152.92 185.19,-142.32 209.27,-133.95" />
<polygon fill="black" stroke="black" points="210.57,-137.21 218.87,-130.62 208.28,-130.59 210.57,-137.21" />
</g>
<!-- Output TX -->
<g id="node3" class="node">
<title>Output TX</title>
<ellipse fill="none" stroke="black" cx="460" cy="-189" rx="58.49" ry="18" />
<text text-anchor="middle" x="460" y="-185.3" font-family="Times,serif" font-size="14.00">Output TX</text>
</g>
<!-- Output RX -->
<g id="node4" class="node">
<title>Output RX</title>
<ellipse fill="none" stroke="black" cx="324" cy="-189" rx="59.59" ry="18" />
<text text-anchor="middle" x="324" y="-185.3" font-family="Times,serif" font-size="14.00">Output RX</text>
</g>
<!-- Output RX&#45;&gt;Processor -->
<g id="edge4" class="edge">
<title>Output RX&#45;&gt;Processor</title>
<path fill="none" stroke="black" d="M307.88,-171.41C299.33,-162.61 288.67,-151.63 279.24,-141.92" />
<polygon fill="black" stroke="black" points="281.48,-139.2 272,-134.47 276.46,-144.08 281.48,-139.2" />
</g>
<!-- Monitor TX2 -->
<g id="node5" class="node">
<title>Monitor TX2</title>
<ellipse fill="none" stroke="black" cx="360" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="360" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text>
</g>
<!-- Monitor TX1 -->
<g id="node6" class="node">
<title>Monitor TX1</title>
<ellipse fill="none" stroke="black" cx="204" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="204" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text>
</g>
<!-- Processor&#45;&gt;Input TX -->
<g id="edge1" class="edge">
<title>Processor&#45;&gt;Input TX</title>
<path fill="none" stroke="black" d="M240.08,-134.63C231.6,-143.5 221.02,-154.55 211.69,-164.3" />
<polygon fill="black" stroke="black" points="208.93,-162.12 204.54,-171.76 213.98,-166.96 208.93,-162.12" />
</g>
<!-- Processor&#45;&gt;Output TX -->
<g id="edge3" class="edge">
<title>Processor&#45;&gt;Output TX</title>
<path fill="none" stroke="black" d="M294.52,-130.2C322.05,-139.03 359.93,-151.4 393,-163 400.09,-165.49 407.57,-168.19 414.86,-170.88" />
<polygon fill="black" stroke="black" points="414.04,-174.3 424.63,-174.5 416.47,-167.74 414.04,-174.3" />
</g>
<!-- Processor&#45;&gt;Monitor TX2 -->
<g id="edge6" class="edge">
<title>Processor&#45;&gt;Monitor TX2</title>
<path fill="none" stroke="black" d="M276.55,-100C292.11,-87.87 313.7,-71.06 331.03,-57.57" />
<polygon fill="black" stroke="black" points="333.4,-60.15 339.14,-51.25 329.1,-54.63 333.4,-60.15" />
</g>
<!-- Processor&#45;&gt;Monitor TX1 -->
<g id="edge5" class="edge">
<title>Processor&#45;&gt;Monitor TX1</title>
<path fill="none" stroke="black" d="M245.23,-99.22C238.09,-88.1 228.6,-73.32 220.52,-60.73" />
<polygon fill="black" stroke="black" points="223.29,-58.56 214.94,-52.04 217.4,-62.35 223.29,-58.56" />
</g>
</g>
</svg>
</div>

<p>The internal complexity varies, but the principle is:</p>

<ul>
  <li>Given an input of X</li>
  <li>Generate the payload of X into Y and Z</li>
  <li>Transmit Y to the monitor interface</li>
  <li>Transmit Z to the output interface</li>
</ul>

<p>It is possible to buy active taps, with the capability to ‘fail open’ meaning in the event
of a power failure traffic will continue to flow.</p>

<p>I still prefer to use passive taps, which should be as resilient as a fibre patch panel.</p>

<h2 id="why-do-we-want-to-aggregate-it">Why do we want to aggregate it?</h2>
<p>In the most simplistic deployment, we can simply send from the source to the destination:</p>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: one to one tap Pages: 1 -->
<svg role="img" aria-label="one to one tap" width="204pt" height="44pt" viewBox="0.00 0.00 203.89 44.00">
<title>one to one tap</title>
<desc>digraph &quot;one to one tap&quot; {

rankdir=LR;
&quot;TAP&quot; -&gt; &quot;Analyser&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>one to one tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-40 199.89,-40 199.89,4 -4,4" />
<!-- TAP -->
<g id="node1" class="node">
<title>TAP</title>
<ellipse fill="none" stroke="black" cx="28.6" cy="-18" rx="28.7" ry="18" />
<text text-anchor="middle" x="28.6" y="-14.3" font-family="Times,serif" font-size="14.00">TAP</text>
</g>
<!-- Analyser -->
<g id="node2" class="node">
<title>Analyser</title>
<ellipse fill="none" stroke="black" cx="144.54" cy="-18" rx="51.19" ry="18" />
<text text-anchor="middle" x="144.54" y="-14.3" font-family="Times,serif" font-size="14.00">Analyser</text>
</g>
<!-- TAP&#45;&gt;Analyser -->
<g id="edge1" class="edge">
<title>TAP&#45;&gt;Analyser</title>
<path fill="none" stroke="black" d="M57.47,-18C65.23,-18 73.96,-18 82.82,-18" />
<polygon fill="black" stroke="black" points="82.83,-21.5 92.83,-18 82.83,-14.5 82.83,-21.5" />
</g>
</g>
</svg>
</div>

<p>However, there are a number of reasons to have an aggregation step in the middle:</p>

<ul>
  <li>Number of ingress points
    <ul>
      <li>Aggregation of smaller capture points into larger interfaces</li>
      <li>Reduction in rack space required for analysers, servers etc</li>
      <li>Strategic aggregation to reduce physical requirements (fibre, rack space)</li>
    </ul>
  </li>
  <li>Multiple destinations
    <ul>
      <li>Apply filtering logic to save on analyser licensing</li>
      <li>Send traffic to security appliances and network monitoring devices</li>
    </ul>
  </li>
  <li>Apply software logic to capture rules</li>
  <li>Support multiple media types
    <ul>
      <li>Provide longer reach for copper-based taps</li>
      <li>SMF, MMF, XFP, QSFP, Copper support</li>
    </ul>
  </li>
  <li>Single view of traffic
    <ul>
      <li>Certain DPI/IDS appliances require full flows, difficult in ECMP networks</li>
      <li>I don’t recommend this due to the associated scaling issues</li>
    </ul>
  </li>
</ul>

<p>Downsides to having an aggregation step:</p>

<ul>
  <li>Potential congestion issues (we’re taking raw traffic, limited by the sender)</li>
  <li>Single point of failure
    <ul>
      <li>This could be mitigated using layer 1 fibre switches or similar</li>
      <li>It’s for monitoring traffic, so uptime is likely not as critical</li>
    </ul>
  </li>
  <li>Cost</li>
</ul>

<p>Historically TAP aggregation has been a very expensive game, around 2-4k a port!</p>

<p>Thankfully Arista changed that with their 7150 series switch, which supports a tap mode
as well as a ‘DANZ’ software suite for loss/latency monitoring, packet filtering and mirroring.</p>

<p>The DANZ suite is now available on the 7150, 7280E and 7500E series switches from Arista,
opening up options from 1/2U fixed form to 7/11U chassi based deployments.</p>

<p>The 7150 series gives some nice features:</p>

<ul>
  <li>Port density; up to 64 10G ports</li>
  <li>LANZ+ features for micro-burst analysis</li>
  <li>PTP support for packet time stamping</li>
  <li>~350ns latency for all packets</li>
  <li>Multi-port mirroring</li>
  <li>Hitless (ISSU) upgrades</li>
  <li>A ‘normal’ Linux environment and Python based toolset</li>
  <li>You configure it like any other switch!</li>
</ul>

<h2 id="lets-implement-a-solution">Let’s implement a solution!</h2>

<p>We’ll keep it simple with 1 aggregation point, 6 inputs and 2 outputs.
In reality, this could be multiple levels of aggregation.</p>

<p>Inputs:</p>

<ul>
  <li>2 x Passive taps</li>
  <li>2 x SPANs</li>
  <li>2 x Active taps</li>
</ul>

<p>Logical Groups:</p>

<ul>
  <li>Group 1 - Internet</li>
  <li>Group 2 - Corporate</li>
  <li>Group 3 - Regional</li>
</ul>

<p>Outputs:</p>

<ul>
  <li>Bro Network Security Monitor (Internet + Regional only)</li>
  <li>Server (Corporate only)</li>
</ul>

<h3 id="logical-diagram">Logical Diagram</h3>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: active tap Pages: 1 -->
<svg role="img" aria-label="active tap" width="1246pt" height="243pt" viewBox="0.00 0.00 1246.00 243.00">
<title>active tap</title>
<desc>digraph &quot;active tap&quot; {

subgraph cluster_PassiveTap {
  label = &quot;Passive Optical Tap&quot;;
    color = black;
  &quot;Transit Provider 1&quot;;
  &quot;Transit Provider 2&quot;;
}
subgraph cluster_Corporate1 {
  label = &quot;Corporate DMZ&quot;;
    color = black;
  &quot;Corporate Spine 1&quot;;
}
subgraph cluster_Corporate2 {
  label = &quot;Corporate DMZ&quot;;
    color = black;
  &quot;Corporate Spine 2&quot;;
}
subgraph cluster_Regional {
  label = &quot;Active TAP&quot;;
    color = black;
  &quot;Wan Provider 1&quot;;
  &quot;Wan Provider 2&quot;;
}
subgraph cluster_7150 {
  color = black;
  shape = square;
  &quot;Tap Switch&quot;;
}
subgraph cluster_Bro {
  color = black;
  shape = square;
  &quot;Bro Network Security Monitor&quot;;
}
subgraph cluster_Server {
  color = black;
  shape = square;
  &quot;Secret Server&quot;;
}

&quot;Transit Provider 1&quot; -&gt; &quot;Tap Switch&quot;
&quot;Transit Provider 2&quot; -&gt; &quot;Tap Switch&quot;
&quot;Corporate Spine 1&quot; -&gt; &quot;Tap Switch&quot;
&quot;Corporate Spine 2&quot; -&gt; &quot;Tap Switch&quot;
&quot;Wan Provider 1&quot; -&gt; &quot;Tap Switch&quot;
&quot;Wan Provider 2&quot; -&gt; &quot;Tap Switch&quot;

&quot;Tap Switch&quot; -&gt; &quot;Bro Network Security Monitor&quot;
&quot;Tap Switch&quot; -&gt; &quot;Secret Server&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 239)">
<title>active tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-239 1242,-239 1242,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_PassiveTap</title>
<polygon fill="none" stroke="black" points="8,-152 8,-227 425,-227 425,-152 8,-152" />
<text text-anchor="middle" x="216.5" y="-211.8" font-family="Times,serif" font-size="14.00">Passive Optical Tap</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Corporate1</title>
<polygon fill="none" stroke="black" points="433,-152 433,-227 641,-227 641,-152 433,-152" />
<text text-anchor="middle" x="537" y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Corporate2</title>
<polygon fill="none" stroke="black" points="649,-152 649,-227 857,-227 857,-152 649,-152" />
<text text-anchor="middle" x="753" y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_Regional</title>
<polygon fill="none" stroke="black" points="865,-152 865,-227 1230,-227 1230,-152 865,-152" />
<text text-anchor="middle" x="1047.5" y="-211.8" font-family="Times,serif" font-size="14.00">Active TAP</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_7150</title>
<polygon fill="none" stroke="black" points="575,-80 575,-132 715,-132 715,-80 575,-80" />
</g>
<g id="clust6" class="cluster">
<title>cluster_Bro</title>
<polygon fill="none" stroke="black" points="360,-8 360,-60 680,-60 680,-8 360,-8" />
</g>
<g id="clust7" class="cluster">
<title>cluster_Server</title>
<polygon fill="none" stroke="black" points="688,-8 688,-60 854,-60 854,-8 688,-8" />
</g>
<!-- Transit Provider 1 -->
<g id="node1" class="node">
<title>Transit Provider 1</title>
<ellipse fill="none" stroke="black" cx="321" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="321" y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 1</text>
</g>
<!-- Tap Switch -->
<g id="node7" class="node">
<title>Tap Switch</title>
<ellipse fill="none" stroke="black" cx="645" cy="-106" rx="61.99" ry="18" />
<text text-anchor="middle" x="645" y="-102.3" font-family="Times,serif" font-size="14.00">Tap Switch</text>
</g>
<!-- Transit Provider 1&#45;&gt;Tap Switch -->
<g id="edge1" class="edge">
<title>Transit Provider 1&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M378.12,-163.53C394.53,-159.73 412.46,-155.64 429,-152 481.93,-140.36 542.33,-127.84 585.77,-118.97" />
<polygon fill="black" stroke="black" points="586.51,-122.39 595.61,-116.97 585.11,-115.54 586.51,-122.39" />
</g>
<!-- Transit Provider 2 -->
<g id="node2" class="node">
<title>Transit Provider 2</title>
<ellipse fill="none" stroke="black" cx="112" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="112" y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 2</text>
</g>
<!-- Transit Provider 2&#45;&gt;Tap Switch -->
<g id="edge2" class="edge">
<title>Transit Provider 2&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M164.63,-162.93C181,-158.94 199.16,-154.89 216,-152 341.71,-130.39 490.05,-117.62 575.25,-111.49" />
<polygon fill="black" stroke="black" points="575.6,-114.97 585.33,-110.77 575.1,-107.99 575.6,-114.97" />
</g>
<!-- Corporate Spine 1 -->
<g id="node3" class="node">
<title>Corporate Spine 1</title>
<ellipse fill="none" stroke="black" cx="537" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="537" y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 1</text>
</g>
<!-- Corporate Spine 1&#45;&gt;Tap Switch -->
<g id="edge3" class="edge">
<title>Corporate Spine 1&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M562.32,-160.59C577.26,-150.9 596.33,-138.55 612.38,-128.14" />
<polygon fill="black" stroke="black" points="614.46,-130.96 620.95,-122.59 610.65,-125.09 614.46,-130.96" />
</g>
<!-- Corporate Spine 2 -->
<g id="node4" class="node">
<title>Corporate Spine 2</title>
<ellipse fill="none" stroke="black" cx="753" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="753" y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 2</text>
</g>
<!-- Corporate Spine 2&#45;&gt;Tap Switch -->
<g id="edge4" class="edge">
<title>Corporate Spine 2&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M727.68,-160.59C712.74,-150.9 693.67,-138.55 677.62,-128.14" />
<polygon fill="black" stroke="black" points="679.35,-125.09 669.05,-122.59 675.54,-130.96 679.35,-125.09" />
</g>
<!-- Wan Provider 1 -->
<g id="node5" class="node">
<title>Wan Provider 1</title>
<ellipse fill="none" stroke="black" cx="1139" cy="-178" rx="82.59" ry="18" />
<text text-anchor="middle" x="1139" y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 1</text>
</g>
<!-- Wan Provider 1&#45;&gt;Tap Switch -->
<g id="edge5" class="edge">
<title>Wan Provider 1&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M1093.04,-162.86C1078.72,-158.87 1062.8,-154.84 1048,-152 932.3,-129.79 795.66,-117.39 714.9,-111.46" />
<polygon fill="black" stroke="black" points="715.07,-107.97 704.85,-110.74 714.57,-114.95 715.07,-107.97" />
</g>
<!-- Wan Provider 2 -->
<g id="node6" class="node">
<title>Wan Provider 2</title>
<ellipse fill="none" stroke="black" cx="956" cy="-178" rx="82.59" ry="18" />
<text text-anchor="middle" x="956" y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 2</text>
</g>
<!-- Wan Provider 2&#45;&gt;Tap Switch -->
<g id="edge6" class="edge">
<title>Wan Provider 2&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M906.81,-163.54C892.12,-159.65 875.94,-155.52 861,-152 808.42,-139.61 748.23,-127.22 704.76,-118.58" />
<polygon fill="black" stroke="black" points="705.41,-115.14 694.92,-116.64 704.05,-122.01 705.41,-115.14" />
</g>
<!-- Bro Network Security Monitor -->
<g id="node8" class="node">
<title>Bro Network Security Monitor</title>
<ellipse fill="none" stroke="black" cx="520" cy="-34" rx="152.17" ry="18" />
<text text-anchor="middle" x="520" y="-30.3" font-family="Times,serif" font-size="14.00">Bro Network Security Monitor</text>
</g>
<!-- Tap Switch&#45;&gt;Bro Network Security Monitor -->
<g id="edge7" class="edge">
<title>Tap Switch&#45;&gt;Bro Network Security Monitor</title>
<path fill="none" stroke="black" d="M617.88,-89.81C600.64,-80.16 578.06,-67.51 558.93,-56.8" />
<polygon fill="black" stroke="black" points="560.57,-53.71 550.14,-51.88 557.15,-59.82 560.57,-53.71" />
</g>
<!-- Secret Server -->
<g id="node9" class="node">
<title>Secret Server</title>
<ellipse fill="none" stroke="black" cx="771" cy="-34" rx="75.29" ry="18" />
<text text-anchor="middle" x="771" y="-30.3" font-family="Times,serif" font-size="14.00">Secret Server</text>
</g>
<!-- Tap Switch&#45;&gt;Secret Server -->
<g id="edge8" class="edge">
<title>Tap Switch&#45;&gt;Secret Server</title>
<path fill="none" stroke="black" d="M672.34,-89.81C690.21,-79.88 713.79,-66.78 733.41,-55.88" />
<polygon fill="black" stroke="black" points="735.36,-58.8 742.4,-50.89 731.96,-52.69 735.36,-58.8" />
</g>
</g>
</svg>
</div>

<h3 id="switch-configuration">Switch configuration</h3>
<p>The switch config is where we wire everything together, there are 3 key concepts:</p>

<ul>
  <li>Tap - input</li>
  <li>Tool - output</li>
  <li>Tap Group - logical grouping of TAP ports</li>
</ul>

<p>The configuration is quite simple and
<a href="https://www.arista.com/en/um-eos/eos-section-16-3-tap-aggregation-configuration">well documented</a>.</p>

<p>First, let’s put the switch into tap mode</p>

<pre><code>switch&gt;en
switch#configure terminal
switch(config)#tap aggregation
switch(config-tap-agg)#mode exclusive
</code></pre>

<p>This will place all switch ports into error disabled and enable tap/tool ports.</p>

<p>Next, define our tap ports</p>

<pre><code>switch(config)#interface ethernet 1
switch(config-if-Et1)#description Transit Provider 1
switch(config-if-Et1)#switchport mode tap
switch(config-if-Et1)#switchport tool group INTERNET

switch(config)#interface ethernet 2
switch(config-if-Et2)#description Transit Provider 2
switch(config-if-Et2)#switchport mode tap
switch(config-if-Et2)#switchport tool group INTERNET

switch(config)#interface ethernet 3
switch(config-if-Et3)#description Corporate Spine 1
switch(config-if-Et3)#switchport mode tap
switch(config-if-Et3)#switchport tool group CORPORATE

switch(config)#interface ethernet 4
switch(config-if-Et4)#description Corporate Spine 2
switch(config-if-Et4)#switchport mode tap
switch(config-if-Et4)#switchport tool group CORPORATE

switch(config)#interface ethernet 5
switch(config-if-Et5)#description Wan Provider 1
switch(config-if-Et5)#switchport mode tap
switch(config-if-Et5)#switchport tool group WAN

switch(config)#interface ethernet 6
switch(config-if-Et6)#description Wan Provider 2
switch(config-if-Et6)#switchport mode tap
switch(config-if-Et6)#switchport tool group WAN
</code></pre>

<p>We now have 3 groups with 3 interfaces in each.</p>

<p>Finally, map those groups onto our outputs.</p>

<pre><code>switch(config)#interface ethernet 10
switch(config-if-Et10)#description Bro Network Security Monitor
switch(config-if-Et10)#switchport mode tool
switch(config-if-Et10)#switchport tool group set INTERNET WAN

switch(config)#interface ethernet 11
switch(config-if-Et11)#description Secret Server
switch(config-if-Et11)#switchport mode tool
switch(config-if-Et11)#switchport tool group set CORPORATE
</code></pre>

<p>Et10 + Et11 will now receive any traffic sent to their relevant groups.</p>

<h3 id="advanced-features">Advanced features</h3>
<p>In the demo, we have a static input -&gt; output allocation in real life this can be
software controlled or filter based.</p>

<p>We could also truncate packets to look at only their headers,
potentially useful for encrypted traffic.</p>

<p>A simple traffic steering example is as below:</p>

<ul>
  <li>For traffic coming into Eth1</li>
  <li>Match traffic targeting 8.8.8.8</li>
  <li>Send to tap group GOOGLE_DNS</li>
  <li>Send tap group GOOGLE_DNS to Eth20</li>
</ul>

<pre><code>switch(config)#ip access-list ACL_GOOGLE_DNS
switch(config-acl-ACL_GOOGLE_DNS)#permit ip any 8.8.8.8/32

switch(config)#class-map type tapagg match-any TAP_CLASS_MAP
switch(config-cmap-TAP_CLASS_MAP)#match ip access-group ACL_GOOGLE_DNS

switch(config)#policy-map type tapagg TAP_POLICY
switch(config-pmap-TAP_POLICY)#class TAP_CLASS_MAP
switch(config-pmap-TAP_POLICY-TAP_CLASS_MAP)#set aggregation-group GOOGLE_DNS

switch(config)#interface ethernet 20
switch(config-if-Et20)#description Magic Box
switch(config-if-Et20)#switchport mode tool
switch(config-if-Et20)#switchport tool group set GOOGLE_DNS

switch(config)#interface ethernet1
switch(config-if-Et1)#service-policy type tapagg input TAP_CLASS_MAP
</code></pre>

<p>For software-based control, Arista provides a powerful HTTP API as well as
XMPP client support and ‘on-device’ APIs. The Python eAPI client can be found on
<a href="https://github.com/arista-eosplus/pyeapi">GitHub</a>, with some <a href="https://github.com/arista-eosplus/pyeapi/tree/develop/examples">examples</a>.</p>

<h1 id="summary">Summary</h1>

<p>It is cost effective to deploy tap infrastructure where required.
The offering from Arista is very powerful, allowing flexibility to meet any number
of requirements.</p>

<p>With a number of integration options (JSON API, Python API, XMPP client),
having dynamic tapping capabilities is a nice spanner to have in your toolbox.</p>

<p>And the cost? Basically, about the same as a 10G switch with routing functionality.</p>

<p>Naturally, the cost is varied depending on physical requirements (fibre/copper runs),
port speeds (1/10/25/40/100G) and port count; this is applicable to any switch or
other tap based deployment.</p>

<h2 id="footnote">Footnote</h2>
<p>I would advise any tap deployments to be carefully planned, certain topologies,
such as multi-stage clos networks do not make good tap targets, both due to the number
of links involved and the resulting bandwidth requirements for the TAP infrastructure.</p>

<p>Depending on your goals, tapping at natural points of congestion, such as
the ingress/egress points for your high performance/bandwidth network segments
(transit links, firewalls etc), will likely provide highly useful information at
a vastly reduce capture complexity.</p>

    </div>
</article>


<section id="related">
    <h2>Related posts</h2>
    <ul id="related_posts">
    
        <li>&raquo; <a href="/2017/12/decoding-ipfix-options-using-go/">Decoding IPFIX options using Go</a></li>
    
        <li>&raquo; <a href="/2017/12/decoding-arista-ethertype-headers-with-gopacket/">Decoding Arista EtherType headers with gopacket</a></li>
    
        <li>&raquo; <a href="/2017/12/a-look-at-traffic-encryption-options/">A look at traffic encryption options</a></li>
    
    </ul>
</section>



<section id="comment">
    <h2>Comments</h2>
    <div id="disqus_thread" aria-live="polite">
        <noscript>Please enable JavaScript to view the comments</noscript>
    </div>
</section>

<script type="text/javascript">
    var disqus_identifier = 'http://damianzaremba.co.uk/2017/12/a-look-at-low-cost-tap-aggregation/';
    var disqus_url = 'http://damianzaremba.co.uk/2017/12/a-look-at-low-cost-tap-aggregation/';

    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://damianzaremba.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <p class="text-muted">Copyright 2009-2022 <a href="http://damianzaremba.co.uk">Damian Zaremba</a></p>
        <ul id="ads">
          <li>Need error tracking? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li>
          <li>Need cloud instances? Jump on <a href="http://www.bigv.io">BigV</a></li>
          <li>Want my website? <a href="https://github.com/DamianZaremba/damianzaremba.co.uk/">Source</a></li>
        </ul>
      </div>
    </footer>

    <!-- JS scripts -->
    <script src="/assests/js/jquery.min.js"></script>
    <script src="/assests/js/bootstrap.min.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_require', 'inpage_linkid', '//www.google-analytics.com/plugins/ga/inpage_linkid.js']);
      _gaq.push(['_setAccount', 'UA-11817192-1']);
      _gaq.push(['_setDomainName', 'damianzaremba.co.uk']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = '//stats.g.doubleclick.net/dc.js'
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();

      (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//damianzaremba.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>

    <!--[if lt IE 9]>
      <script src="/assests/js/html5shiv.min.js"></script>
      <script src="/assests/js/respond.min.js"></script>
    <![endif]-->
  </body>
</html>
