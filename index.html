<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Damian Zaremba - Blog</title>

    <!-- General meta data -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Damian Zaremba's Blog" />
    <meta name="google-site-verification" content="qykIg-4DghoGe78ET4eRjKG1cx6n3gXvu4jF0FvcwRo" />
    <meta name="author" content="Damian Zaremba" />
    <link rel="alternate" type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba" />

    <!-- Robot meta data -->
    <meta name="robots" content="INDEX" />
    <meta name="robots" content="FOLLOW" />
    <meta name="robots" content="INDEX,FOLLOW" />

    <!-- CSS files -->
    <link href="/assests/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assests/css/main.css" rel="stylesheet">

    <!--
    RIPA NOTICE: No consent is given for the interception of this page transmission
    -->
  </head>
  <body>

    <!-- Header -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Damian Zaremba</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Blog</a></li>
            <li class=""><a href="/about/">About</a></li>
            <li class=""><a href="/cv/">CV</a></li>
            <li class=""><a href="/archive/">Archive</a></li>
            <li class=""><a href="/projects/">Projects</a></li>
          </ul>

          <div class="social-icons navbar-right visible-md visible-lg">
            <a href="https://twitter.com/DamianZaremba">
              <img class="twitter" src="/assests/images/twitter.png" alt="Twitter" />
            </a>
            <a href="https://github.com/DamianZaremba">
              <img class="github" src="/assests/images/github.png" alt="GitHub" />
            </a>
            <a href="https://feeds.feedburner.com/DamianZaremba">
              <img class="rss" src="/assests/images/rss.png" alt="RSS" />
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Page -->
    <div class="container">

    
    <article class="post">
        <h1 class="title"><a href="/2017/12/decoding-ipfix-options-using-go/">Decoding IPFIX options using Go</a></h1>
        <div class="meta">
            <span><img src="/assests/images/date.png" title="Date" alt="Date" />28 Dec 2017</span>
            <span><img src="/assests/images/comments.png" title="Content" alt="Content" /><a href="/2017/12/decoding-ipfix-options-using-go/#disqus_thread">Comments</a></span>
            
                <ul class="categories">
                <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/go'>Go</a></li></ul>
            
        </div>
        <div class="entry">
            <p>The IPFIX (IP Flow Information Export) protocol provides an extensible
standard for transmitting network flow data.</p>

<p>A key difference compared to the likes of <a href="http://www.sflow.org/">sflow</a>,
is the template-based nature of data.</p>

<p>While very similar to NetFlow version 9, IPFIX enables variable length fields
and vendor extensions. This makes the protocol suitable for different types of
performance data, as desired by any vendor.</p>

<p>A recent project required some processing of IPFIX flow data,
which this post will focus on.</p>

<p><em>TL;DR The full implementation can be found on
<a href="https://github.com/DamianZaremba/ipfix_options_demo">Github</a></em></p>

<h2 id="parsing-options">Parsing options</h2>
<p>A number of IPFIX decoder implementations exist in Go,
most are included in flow decoder implementations,
rather than standalone libraries.</p>

<p>The best stand-alone library I could fix is
<a href="https://github.com/calmh/ipfix">github.com/calmh/ipfix</a>, but this
doesn’t support
<a href="https://github.com/calmh/ipfix/blob/master/parser.go#L296-L301">decoding options</a>.</p>

<p>To better understand the scope of implementation and overall structure of IPFIX,
a stand-alone decoder was implemented.</p>

<h2 id="data-structure">Data structure</h2>
<p>To begin implementing our own decoder, we first need to understand the format of packets
used in IPFIX.</p>

<p>We can use both the <a href="https://www.iana.org/assignments/ipfix/ipfix.xhtml">IANA field assignments</a>
and <a href="https://tools.ietf.org/html/rfc7011">RFC</a> to construct our base expectations.</p>

<p>At a high level, there is 1 common header then 3 different payload types</p>

<ul>
  <li>Data template</li>
  <li>Options template</li>
  <li>Data set</li>
</ul>

<p>We are interested in the options template and data set (where we have a matching template ID, more on this later).</p>

<h2 id="decoding-the-header">Decoding the header</h2>

<p>As described in the <a href="https://tools.ietf.org/html/rfc7011#section-3.1">RFC</a>, we can expect 5 fields.</p>

<p>Followed by the message header we have a set identifier, which describes the message contents;
for our purposes, we will use this as part of the header.</p>

<pre><code class="language-go">header := IpfixHeader{
	Version:        binary.BigEndian.Uint16(payload[0:2]),
	MessageLength:  binary.BigEndian.Uint16(payload[2:4]),
	ExportTime:     binary.BigEndian.Uint32(payload[4:8]),
	SequenceNumber: binary.BigEndian.Uint32(payload[8:12]),
	DomainId:       binary.BigEndian.Uint32(payload[12:16]),
	SetId:          binary.BigEndian.Uint16(payload[16:20]),
}
</code></pre>

<p>We are interested in any SetId that is 3 (options template) or &gt;= 256 (data set).</p>

<h2 id="decoding-the-template">Decoding the template</h2>

<p>Before any data can be decoded, we must have a matching template.</p>

<p>Without the template, there is no way to know how the fields are mapped inside the data set.</p>

<p>Each template payload (SetId 2 or 3) has a header containing the ID and field counts.</p>

<pre><code class="language-go">template := OptionsTemplate{
  TemplateId:      binary.BigEndian.Uint16(payload[0:2]),
  FieldCount:      binary.BigEndian.Uint16(payload[2:4]),
  ScopeFieldCount: binary.BigEndian.Uint16(payload[4:6]),
}
</code></pre>

<p>Once again, using the <a href="https://tools.ietf.org/html/rfc7011#section-3.4.1">RFC</a>,
we can determine the payload is a sequence of field separators.</p>

<p>The number of separators corresponds to the values in the header we just decoded.</p>

<p>The ordering of these fields is critical for us to maintain.</p>

<p>Note: Unlike a data template, the options template has a set of scope fields.</p>

<h3 id="decode-the-fields">Decode the fields</h3>
<p>Both scope fields and fields have the same structure, thus can be decoded
using the same logic.</p>

<pre><code class="language-go">func decodeSingleTemplateField(payload []byte) (TemplateField, int) {
  tf := TemplateField{
    ElementId: binary.BigEndian.Uint16(payload[0:2]),
    Length:    binary.BigEndian.Uint16(payload[2:4]),
  }

  if tf.ElementId &gt; 0x8000 {
    tf.ElementId = tf.ElementId &amp; 0x7fff
    tf.EnterpriseNumber = binary.BigEndian.Uint32(payload[0:4])
    return tf, 8
  }

  return tf, 4
}
</code></pre>

<p>It’s then simply a case of decoding each field in sequence and storing them for later</p>

<pre><code class="language-go">// Get all scope entries
for i := template.ScopeFieldCount; i &gt; 0; i-- {
  tf, cut := decodeSingleTemplateField(byteSlice)
  template.ScopeField = append(template.ScopeField, tf)

  if len(byteSlice) &lt; cut {
    break
  }
  byteSlice = byteSlice[cut:]
}

// Get all field entries
for i := template.FieldCount - template.ScopeFieldCount; i &gt; 0; i-- {
  tf, cut := decodeSingleTemplateField(byteSlice)
  template.Field = append(template.Field, tf)

  if len(byteSlice) &lt; cut {
    break
  }
  byteSlice = byteSlice[cut:]
}
</code></pre>

<h3 id="cache-the-template">Cache the template</h3>

<p>Now we have the template decoded, it is important to store it.
The fields described in the template need to be used when decoding the data set,
which we will look at next.</p>

<p>A simple way to store this is using the LRU cache implementation from Hashicorp,
<a href="github.com/hashicorp/golang-lru">github.com/hashicorp/golang-lru</a>.</p>

<p>All future lookups will be via the ID, so using this as the key make sense.</p>

<pre><code class="language-go">templateCache, err := lru.New(10240)
if err != nil {
  log.Fatalf("Failed to setup options template cache: %v", err)
}

templateCache.Add(template.Id, template)
</code></pre>

<h2 id="decoding-the-data-set">Decoding the data set</h2>

<p>Any set ID over 255 represents a data set, the set ID refers to the template
we need to use when decoding the data set.</p>

<p>First, we need to ensure we have a matching template for this payload.</p>

<pre><code class="language-go">cacheEntry, ok := templateCache.Get(header.SetId)
if !ok {
  return nil, true
}
template := cacheEntry.(OptionsTemplate)
</code></pre>

<p>Once we have the template, it’s a case of decoding each option in sequence.</p>

<p>Again, both scope fields and fields can be decoded using the same logic.</p>

<h3 id="field-decoding">Field decoding</h3>

<p>The option decoding logic has 3 main tasks:</p>

<ul>
  <li>Read the correct length of bytes off the payload</li>
  <li>Lookup the associated name of the field from the identifier</li>
  <li>Cast the byte array into the correct data type for the identifier</li>
</ul>

<p>The <a href="https://www.iana.org/assignments/ipfix/ipfix.xhtml">IANA field assignments</a>
accurately describe the field data we need to complete these tasks.</p>

<pre><code class="language-go">func decodeSingleOption(byteSlice []byte, field TemplateField, options Options) {
	// Check we have enough data
	if len(byteSlice) &lt; int(field.Length) {
		return
	}

	// Handle each enterprise
	switch field.EnterpriseNumber {
	case 0:
		// Handle elements for enterprise 0
		switch field.ElementId {
		case 34:
			// samplingInterval
			options["samplingInterval"] = binary.BigEndian.Uint32(byteSlice[:int(field.Length)])
		case 36:
			// flowActiveTimeout
			options["flowActiveTimeout"] = binary.BigEndian.Uint16(byteSlice[:int(field.Length)])
		case 37:
			// flowIdleTimeout
			options["flowIdleTimeout"] = binary.BigEndian.Uint16(byteSlice[:int(field.Length)])
		case 41:
			// exportedMessageTotalCount
			options["exportedMessageTotalCount"] = binary.BigEndian.Uint64(byteSlice[:int(field.Length)])
		case 42:
			// exportedFlowRecordTotalCount
			options["exportedFlowRecordTotalCount"] = binary.BigEndian.Uint64(byteSlice[:int(field.Length)])
		case 130:
			// exporterIPv4Address
			options["exporterIPv4Address"] = net.IP(byteSlice[:int(field.Length)])
		case 131:
			// exporterIPv6Address
			options["exporterIPv6Address"] = net.IP(byteSlice[:int(field.Length)])
		case 144:
			// exportingProcessId
			options["exportingProcessId"] = binary.BigEndian.Uint32(byteSlice[:int(field.Length)])
		case 160:
			// systemInitTimeMilliseconds
			options["exportingProcessId"] = int64(binary.BigEndian.Uint64(byteSlice[:int(field.Length)]))
		case 214:
			// exportProtocolVersion
			options["exportProtocolVersion"] = uint8(byteSlice[0])
		case 215:
			// exportTransportProtocol
			options["exportTransportProtocol"] = uint8(byteSlice[0])
		}
	}
}
</code></pre>

<p>The order of fields in the data set is identical to the order in the template,
so once again it’s just a case of looping over them.</p>

<pre><code class="language-go">// Read all scope field separators
for i := 0; i &lt; len(template.ScopeField); i++ {
  decodeSingleOption(byteSlice, template.ScopeField[i], options)

  if len(byteSlice) &lt; int(template.ScopeField[i].Length) {
    break
  }
  byteSlice = byteSlice[int(template.ScopeField[i].Length):]
}

// Read all field separators
for i := 0; i &lt; len(template.Field); i++ {
  decodeSingleOption(byteSlice, template.Field[i], options)

  if len(byteSlice) &lt; int(template.Field[i].Length) {
    break
  }
  byteSlice = byteSlice[int(template.Field[i].Length):]
}
</code></pre>

<h2 id="result">Result</h2>
<p>We now have a subset of the IANA fields supported in our decoder.</p>

<p>Given a correct template and data payload, the result is a map of received options.</p>

<pre><code class="language-go">map[
  exportedMessageTotalCount: 250
  exportedFlowRecordTotalCount: 10
  samplingInterval: 10
  flowIdleTimeout: 15
  exportingProcessId: 72
  exporterIPv4Address: 192.168.0.1
  exporterIPv6Address: ::
  flowActiveTimeout: 60
  exportProtocolVersion: 10
  exportTransportProtocol: 17
]
</code></pre>

<h2 id="summary">Summary</h2>
<p>IPFIX is a highly flexible protocol with a relatively simple data format,
allowing parsing to be easily implemented.</p>

<p>While the implementation’s boundary checking could be improved,
the exercise of creating an actual implementation from documented implementation
I would recommend to all.</p>

<p>You may also find that some vendors have interesting assumptions within their options
handling, with many configuration knobs missing compared to data templates.</p>

<p>Having this functionality separated from <a href="https://github.com/calmh/ipfix">upstream code</a>
proved to be fruitful, allowing certain options to be stored and distributed outside of
normal flow collection.</p>

<p>The full implementation can be found on
<a href="https://github.com/DamianZaremba/ipfix_options_demo">Github</a>,
with basic test cases added for each implemented field.</p>

        </div>
    </article>
    
    <article class="post">
        <h1 class="title"><a href="/2017/12/decoding-arista-ethertype-headers-with-gopacket/">Decoding Arista EtherType headers with gopacket</a></h1>
        <div class="meta">
            <span><img src="/assests/images/date.png" title="Date" alt="Date" />27 Dec 2017</span>
            <span><img src="/assests/images/comments.png" title="Content" alt="Content" /><a href="/2017/12/decoding-arista-ethertype-headers-with-gopacket/#disqus_thread">Comments</a></span>
            
                <ul class="categories">
                <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/go'>Go</a></li></ul>
            
        </div>
        <div class="entry">
            <p>As we <a href="/2017/12/a-look-at-low-cost-tap-aggregation/">previously discussed</a>,
using cheap switches to aggregate multiple tap sources gives you a lot of power.</p>

<p>However, given the multiple feeds, how can you measure timing information accurately 1 hop away?</p>

<p>Using hardware time stamping provides a highly accurate record of when packets
were processed by devices, making it perfect for TAP aggregation.</p>

<h2 id="revisiting-the-7150-platform">Revisiting the 7150 platform</h2>

<p>On the 7150 series hardware, time stamping is supported at line-rate using PTP.</p>

<p>You have two options for timestamp placement;</p>

<ul>
  <li>Replacement of the FCS (<code>mac timestamp replace-fcs</code>):</li>
</ul>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: 7150 timestamp replace fcs Pages: 1 -->
<svg role="img" aria-label="7150 timestamp replace fcs" width="556pt" height="177pt" viewBox="0.00 0.00 556.00 177.00">
<title>7150 timestamp replace fcs</title>
<desc>digraph &quot;7150 timestamp replace fcs&quot; {

subgraph cluster {
  rankdir=LR;
  height=1.5;
  &quot;Timestamp&quot; [shape=square, height=1.5];
  &quot;Payload&quot; [shape=square, height=1.5];
  &quot;IP Header&quot; [shape=square, height=1.5];
  &quot;Ethernet Header&quot; [shape=square, height=1.5];
}

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 173)">
<title>7150 timestamp replace fcs</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-173 552,-173 552,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-161 540,-161 540,-8 8,-8" />
</g>
<!-- Timestamp -->
<g id="node1" class="node">
<title>Timestamp</title>
<polygon fill="none" stroke="black" points="532,-138.5 424,-138.5 424,-30.5 532,-30.5 532,-138.5" />
<text text-anchor="middle" x="478" y="-80.8" font-family="Times,serif" font-size="14.00">Timestamp</text>
</g>
<!-- Payload -->
<g id="node2" class="node">
<title>Payload</title>
<polygon fill="none" stroke="black" points="406,-138.5 298,-138.5 298,-30.5 406,-30.5 406,-138.5" />
<text text-anchor="middle" x="352" y="-80.8" font-family="Times,serif" font-size="14.00">Payload</text>
</g>
<!-- IP Header -->
<g id="node3" class="node">
<title>IP Header</title>
<polygon fill="none" stroke="black" points="280,-138.5 172,-138.5 172,-30.5 280,-30.5 280,-138.5" />
<text text-anchor="middle" x="226" y="-80.8" font-family="Times,serif" font-size="14.00">IP Header</text>
</g>
<!-- Ethernet Header -->
<g id="node4" class="node">
<title>Ethernet Header</title>
<polygon fill="none" stroke="black" points="153.5,-153 16.5,-153 16.5,-16 153.5,-16 153.5,-153" />
<text text-anchor="middle" x="85" y="-80.8" font-family="Times,serif" font-size="14.00">Ethernet Header</text>
</g>
</g>
</svg>
</div>

<ul>
  <li>Appending of the timestamp (<code>mac timestamp before-fcs</code>):</li>
</ul>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: 7150 timestamp append Pages: 1 -->
<svg role="img" aria-label="7150 timestamp append" width="682pt" height="177pt" viewBox="0.00 0.00 682.00 177.00">
<title>7150 timestamp append</title>
<desc>digraph &quot;7150 timestamp append&quot; {

subgraph cluster {
  rankdir=LR;
  height=1.5;
  &quot;FCS&quot; [shape=square, height=1.5];
  &quot;Timestamp&quot; [shape=square, height=1.5];
  &quot;Payload&quot; [shape=square, height=1.5];
  &quot;IP Header&quot; [shape=square, height=1.5];
  &quot;Ethernet Header&quot; [shape=square, height=1.5];
}

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 173)">
<title>7150 timestamp append</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-173 678,-173 678,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-161 666,-161 666,-8 8,-8" />
</g>
<!-- FCS -->
<g id="node1" class="node">
<title>FCS</title>
<polygon fill="none" stroke="black" points="658,-138.5 550,-138.5 550,-30.5 658,-30.5 658,-138.5" />
<text text-anchor="middle" x="604" y="-80.8" font-family="Times,serif" font-size="14.00">FCS</text>
</g>
<!-- Timestamp -->
<g id="node2" class="node">
<title>Timestamp</title>
<polygon fill="none" stroke="black" points="532,-138.5 424,-138.5 424,-30.5 532,-30.5 532,-138.5" />
<text text-anchor="middle" x="478" y="-80.8" font-family="Times,serif" font-size="14.00">Timestamp</text>
</g>
<!-- Payload -->
<g id="node3" class="node">
<title>Payload</title>
<polygon fill="none" stroke="black" points="406,-138.5 298,-138.5 298,-30.5 406,-30.5 406,-138.5" />
<text text-anchor="middle" x="352" y="-80.8" font-family="Times,serif" font-size="14.00">Payload</text>
</g>
<!-- IP Header -->
<g id="node4" class="node">
<title>IP Header</title>
<polygon fill="none" stroke="black" points="280,-138.5 172,-138.5 172,-30.5 280,-30.5 280,-138.5" />
<text text-anchor="middle" x="226" y="-80.8" font-family="Times,serif" font-size="14.00">IP Header</text>
</g>
<!-- Ethernet Header -->
<g id="node5" class="node">
<title>Ethernet Header</title>
<polygon fill="none" stroke="black" points="153.5,-153 16.5,-153 16.5,-16 153.5,-16 153.5,-153" />
<text text-anchor="middle" x="85" y="-80.8" font-family="Times,serif" font-size="14.00">Ethernet Header</text>
</g>
</g>
</svg>
</div>

<p>The implementation of this is a little ‘quirky’.</p>

<p>Looking at the <code>Timestamp</code> value alone will not help you as it’s an internal
ASIC counter on the switch, essentially providing the lower half of the timestamp.</p>

<p>To calculate the actual (Unix based) timestamp, another keyframe packet has
to be processed and tracked (every ~6 seconds); providing the first half of the timestamp.</p>

<p>While possible to implement, the imposed state and skew calculations is a little unappealing.</p>

<h2 id="a-look-into-the-7500er7280er-series">A look into the 7500{E,R}/7280{E,R} series</h2>

<p>On the newer platforms, Arista has moved away from using the keyframe setup and
introduced a custom EtherType. Again, using hardware time stamping at line-rate &amp; supporting PTP.</p>

<p>There is 3 possible time stamping modes on the 7500{E,R} &amp; 7280{E,R} series switches:</p>

<ul>
  <li>64-bit header timestamp; i.e., encapsulated in the L2 header</li>
  <li>48-bit header timestamp; i.e., encapsulated in the L2 header</li>
  <li>48-bit timestamp that replaces the Source MAC</li>
</ul>

<p>We will focus on the first 2 options that use a customer EtherType inside the layer 2 header.</p>

<p><em>Note: All timestamps are captured upon packet ingress and stamped on packet egress.</em></p>

<h3 id="a-look-into-the-packet-format">A look into the packet format</h3>

<p>Let’s compare a normal ethernet header:</p>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: ethernet header Pages: 1 -->
<svg role="img" aria-label="ethernet header" width="652pt" height="148pt" viewBox="0.00 0.00 652.00 148.00">
<title>ethernet header</title>
<desc>digraph &quot;ethernet header&quot; {

subgraph cluster {
  rankdir=LR;
  height=1.5;
  &quot;FCS&quot; [shape=square, height=1.5];
  &quot;Payload&quot; [shape=square, height=1.5];
  &quot;Length/Type&quot; [shape=square, height=1.5];
  &quot;Src Address&quot; [shape=square, height=1.5];
  &quot;Dst Address&quot; [shape=square, height=1.5];
}

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 144)">
<title>ethernet header</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-144 648,-144 648,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-132 636,-132 636,-8 8,-8" />
</g>
<!-- FCS -->
<g id="node1" class="node">
<title>FCS</title>
<polygon fill="none" stroke="black" points="628,-124 520,-124 520,-16 628,-16 628,-124" />
<text text-anchor="middle" x="574" y="-66.3" font-family="Times,serif" font-size="14.00">FCS</text>
</g>
<!-- Payload -->
<g id="node2" class="node">
<title>Payload</title>
<polygon fill="none" stroke="black" points="502,-124 394,-124 394,-16 502,-16 502,-124" />
<text text-anchor="middle" x="448" y="-66.3" font-family="Times,serif" font-size="14.00">Payload</text>
</g>
<!-- Length/Type -->
<g id="node3" class="node">
<title>Length/Type</title>
<polygon fill="none" stroke="black" points="376,-124 268,-124 268,-16 376,-16 376,-124" />
<text text-anchor="middle" x="322" y="-66.3" font-family="Times,serif" font-size="14.00">Length/Type</text>
</g>
<!-- Src Address -->
<g id="node4" class="node">
<title>Src Address</title>
<polygon fill="none" stroke="black" points="250,-124 142,-124 142,-16 250,-16 250,-124" />
<text text-anchor="middle" x="196" y="-66.3" font-family="Times,serif" font-size="14.00">Src Address</text>
</g>
<!-- Dst Address -->
<g id="node5" class="node">
<title>Dst Address</title>
<polygon fill="none" stroke="black" points="124,-124 16,-124 16,-16 124,-16 124,-124" />
<text text-anchor="middle" x="70" y="-66.3" font-family="Times,serif" font-size="14.00">Dst Address</text>
</g>
</g>
</svg>
</div>

<p>To one with the customer EtherType inserted:</p>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: ethernet header extended Pages: 1 -->
<svg role="img" aria-label="ethernet header extended" width="1100pt" height="148pt" viewBox="0.00 0.00 1100.00 148.00">
<title>ethernet header extended</title>
<desc>digraph &quot;ethernet header extended&quot; {

subgraph cluster {
  rankdir=LR;
  height=1.5;
  &quot;FCS&quot; [shape=square, height=1.5];
  &quot;Payload&quot; [shape=square, height=1.5];
  &quot;Length/Type&quot; [shape=square, height=1.5];
  &quot;Timestamp&quot; [shape=square, height=1.2];
  &quot;Version&quot; [shape=square, height=1.2];
  &quot;Sub-Type&quot; [shape=square, height=1.2];
  &quot;EtherType&quot; [shape=square, height=1.5];
  &quot;Src Address&quot; [shape=square, height=1.5];
  &quot;Dst Address&quot; [shape=square, height=1.5];
}

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 144)">
<title>ethernet header extended</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-144 1096,-144 1096,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-132 1084,-132 1084,-8 8,-8" />
</g>
<!-- FCS -->
<g id="node1" class="node">
<title>FCS</title>
<polygon fill="none" stroke="black" points="1076,-124 968,-124 968,-16 1076,-16 1076,-124" />
<text text-anchor="middle" x="1022" y="-66.3" font-family="Times,serif" font-size="14.00">FCS</text>
</g>
<!-- Payload -->
<g id="node2" class="node">
<title>Payload</title>
<polygon fill="none" stroke="black" points="950,-124 842,-124 842,-16 950,-16 950,-124" />
<text text-anchor="middle" x="896" y="-66.3" font-family="Times,serif" font-size="14.00">Payload</text>
</g>
<!-- Length/Type -->
<g id="node3" class="node">
<title>Length/Type</title>
<polygon fill="none" stroke="black" points="824,-124 716,-124 716,-16 824,-16 824,-124" />
<text text-anchor="middle" x="770" y="-66.3" font-family="Times,serif" font-size="14.00">Length/Type</text>
</g>
<!-- Timestamp -->
<g id="node4" class="node">
<title>Timestamp</title>
<polygon fill="none" stroke="black" points="698,-118 602,-118 602,-22 698,-22 698,-118" />
<text text-anchor="middle" x="650" y="-66.3" font-family="Times,serif" font-size="14.00">Timestamp</text>
</g>
<!-- Version -->
<g id="node5" class="node">
<title>Version</title>
<polygon fill="none" stroke="black" points="584,-113 498,-113 498,-27 584,-27 584,-113" />
<text text-anchor="middle" x="541" y="-66.3" font-family="Times,serif" font-size="14.00">Version</text>
</g>
<!-- Sub&#45;Type -->
<g id="node6" class="node">
<title>Sub&#45;Type</title>
<polygon fill="none" stroke="black" points="480,-113 394,-113 394,-27 480,-27 480,-113" />
<text text-anchor="middle" x="437" y="-66.3" font-family="Times,serif" font-size="14.00">Sub&#45;Type</text>
</g>
<!-- EtherType -->
<g id="node7" class="node">
<title>EtherType</title>
<polygon fill="none" stroke="black" points="376,-124 268,-124 268,-16 376,-16 376,-124" />
<text text-anchor="middle" x="322" y="-66.3" font-family="Times,serif" font-size="14.00">EtherType</text>
</g>
<!-- Src Address -->
<g id="node8" class="node">
<title>Src Address</title>
<polygon fill="none" stroke="black" points="250,-124 142,-124 142,-16 250,-16 250,-124" />
<text text-anchor="middle" x="196" y="-66.3" font-family="Times,serif" font-size="14.00">Src Address</text>
</g>
<!-- Dst Address -->
<g id="node9" class="node">
<title>Dst Address</title>
<polygon fill="none" stroke="black" points="124,-124 16,-124 16,-16 124,-16 124,-124" />
<text text-anchor="middle" x="70" y="-66.3" font-family="Times,serif" font-size="14.00">Dst Address</text>
</g>
</g>
</svg>
</div>

<p><em>Note: .1q payloads are also supported, with the EtherType coming after the Source Address</em></p>

<p>As you can see an extra 4 fields have been inserted into the header;</p>

<ul>
  <li>EtherType - 0xD28B - An identifier for AristaEtherType</li>
  <li>Protocol sub-type - 0x1 - A sub-identifier for the AristaEtherType</li>
  <li>Version - 0x10 or 0x20 - An identifier for either 64bit or 48bit</li>
  <li>Timestamp - An IEEE 1588 time of day format</li>
</ul>

<p>The timestamp is either 32 bits (seconds) followed by 32 bits (nanoseconds) or
16 bits (seconds) followed by 32 bits (nanoseconds) depending on the 64 or 48bit mode.</p>

<h4 id="configuration">Configuration</h4>

<p>Enabling hardware timestamping on the platform is rather simple;</p>

<ul>
  <li><code>mac timestamp header</code> enables timestamping on tool ports</li>
  <li><code>mac timestamp header format &lt;64bit | 48bit&gt;</code> sets the format of the timestamp</li>
  <li><code>mac timestamp replace source-mac</code> enables replacing the source mac address with the timestamp</li>
</ul>

<p>There are some limitations to the time stamping support, notably;</p>

<ul>
  <li>Timestamping is done after packet processing, resulting in ~10ns of delay</li>
  <li>64bit timestamps may rollover inconsistency every 4 seconds causing jumps between packets</li>
</ul>

<h3 id="decoding-the-packets">Decoding the packets</h3>

<p>Now we’ve changed the Ethernet header, it requires a specific decoder to be able to process.</p>

<p>Without a specific decoder, it is no longer a valid Ethernet header as Length field
contains a meaningless value.</p>

<p>Arista <a href="https://eos.arista.com/analyzing-packet-header-timestamps-in-wireshark/">provides</a> an
LUA extension for Wireshark for this purpose.</p>

<h2 id="decoding-custom-ethertypes-in-gopacket">Decoding custom EtherTypes in gopacket</h2>
<p><a href="https://github.com/google/gopacket">gopacket</a> has a very useful pcap interface,
making it very easy to process data collected from TAP infrastructure.</p>

<p>Investigating the structure, it made sense to implement a custom
<a href="https://godoc.org/github.com/google/gopacket/layers">layer</a> to handle
our EtherType.</p>

<p>After some experimentation, while this provided decoding of the timestamp data,
it prevented further processing of the packets, resulting in the IP layer
being inaccessible; this was complicated due to our now invalid Ethernet header.</p>

<p>A simple solution of extending the built-in
<a href="https://godoc.org/github.com/google/gopacket/layers#EthernetType">EthernetType</a>
was called for.</p>

<pre><code class="language-go">// Copyright 2012 Google, Inc. All rights reserved.
// Copyright 2009-2011 Andreas Krennmair. All rights reserved.
//
// Use of this source code is governed by a BSD-style license
// that can be found in the LICENSE file in the root of the source
// tree.
package decoder

import (
	"encoding/binary"
	"errors"
	"github.com/google/gopacket"
	"github.com/google/gopacket/layers"
	"net"
)

// This layer has a two-byte protocol subtype of 0x1,
// a two-byte protocol version of 0x10 and
// an eight-byte UTC timestamp in IEEE 1588 time of format
// So that would be 12 bytes in totally we need to strip off right after the src mac
type AristaEtherType struct {
	ProtocolSubType      uint16
	ProtocolVersion      uint16
	TimestampSeconds     uint32
	TimestampNanoSeconds uint32
}

// AristaExtendedEthernet is the layer of a normal or Arista extended Ethernet frame headers.
// This is the same as layers.Ethernet, but may have AristaEtherType filled with data
type AristaExtendedEthernet struct {
	layers.Ethernet
	AristaEtherType AristaEtherType
}

func (eth *AristaExtendedEthernet) DecodeFromBytes(data []byte, df gopacket.DecodeFeedback) error {
	if len(data) &lt; 14 {
		return errors.New("AristaExtendedEthernet packet too small")
	}
	eth.DstMAC = net.HardwareAddr(data[0:6])
	eth.SrcMAC = net.HardwareAddr(data[6:12])

	// https://eos.arista.com/eos-4-18-1f/tap-aggregation-ingress-header-time-stamping/
	// Arista places 12 bytes directly after the src mac, see AristaEtherType comments for structure
	// We handle both timestamped and non-timestamped frames here
	etherType := binary.BigEndian.Uint16(data[12:14])
	if len(data) &gt;= 26 &amp;&amp; etherType == 53899 {
		eth.AristaEtherType = AristaEtherType{
			ProtocolSubType:      binary.BigEndian.Uint16(data[14:16]),
			ProtocolVersion:      binary.BigEndian.Uint16(data[16:18]),
			TimestampSeconds:     binary.BigEndian.Uint32(data[18:22]),
			TimestampNanoSeconds: binary.BigEndian.Uint32(data[22:26]),
		}
		eth.EthernetType = layers.EthernetType(binary.BigEndian.Uint16(data[26:28]))
		eth.BaseLayer = layers.BaseLayer{data[:28], data[28:]}
	} else {
		eth.EthernetType = layers.EthernetType(binary.BigEndian.Uint16(data[12:14]))
		eth.BaseLayer = layers.BaseLayer{data[:14], data[14:]}
	}

	// Logic from the upstream Ethernet code
	if eth.EthernetType &lt; 0x0600 {
		eth.Length = uint16(eth.EthernetType)
		eth.EthernetType = layers.EthernetTypeLLC
		if cmp := len(eth.Payload) - int(eth.Length); cmp &lt; 0 {
			df.SetTruncated()
		} else if cmp &gt; 0 {
			eth.Payload = eth.Payload[:len(eth.Payload)-cmp]
		}
	}
	return nil
}

// Required methods to be a valid layer
func (e *AristaExtendedEthernet) LinkFlow() gopacket.Flow {
	return gopacket.NewFlow(layers.EndpointMAC, e.SrcMAC, e.DstMAC)
}

func (e *AristaExtendedEthernet) LayerType() gopacket.LayerType {
  return gopacket.LayerType(17)
}

func (eth *AristaExtendedEthernet) NextLayerType() gopacket.LayerType {
	return eth.EthernetType.LayerType()
}

// Public function
func DecodeAristaExtendedEthernet(data []byte, p gopacket.PacketBuilder) error {
	eth := &amp;AristaExtendedEthernet{}
	err := eth.DecodeFromBytes(data, p)
	if err != nil {
		return err
	}
	p.AddLayer(eth)
	p.SetLinkLayer(eth)
	return p.NextDecoder(eth.EthernetType)
}
</code></pre>

<p>Now we have the custom decoder, we just need to register it with gopacket.
This makes gopacket use our decoder implementation rather than the built-in Ethernet one.</p>

<pre><code class="language-go">import (
	"github.com/google/gopacket/layers"
)

func init() {
  layers.LinkTypeMetadata[layers.LinkTypeEthernet] = layers.EnumMetadata{
    DecodeWith: gopacket.DecodeFunc(DecodeAristaExtendedEthernet),
    Name:       "AristaExtendedEthernet",
  }
}
</code></pre>

<p>The custom fields are now accessible on the Ethernet layer, alongside the other fields.</p>

<pre><code class="language-go">layer := packet.Layer(layers.LayerTypeEthernet)
if layer != nil {
  ethernetLayer := layer.(*decoder.AristaExtendedEthernet)
  if ethernetLayer.AristaEtherType.ProtocolSubType != 0 {
    timestamp, err := strconv.ParseFloat(fmt.Sprintf(
      "%d.%d",
      ethernetLayer.AristaEtherType.TimestampSeconds,
      ethernetLayer.AristaEtherType.TimestampNanoSeconds),
      64)
    }
  }
}
</code></pre>

<p>A similar decoder has been successfully tested with 500k/s packets per second.</p>

<h2 id="summary">Summary</h2>
<p>Using standard protocols and cheap hardware we can build powerful performance analysis applications.</p>

<p>This work was inspired by <a href="https://github.com/REANNZ/ruru">Ruru</a>, providing the foundations for
performance monitoring and insights of heavily asymmetric &amp; distributed traffic flows.</p>

        </div>
    </article>
    
    <article class="post">
        <h1 class="title"><a href="/2017/12/a-look-at-traffic-encryption-options/">A look at traffic encryption options</a></h1>
        <div class="meta">
            <span><img src="/assests/images/date.png" title="Date" alt="Date" />26 Dec 2017</span>
            <span><img src="/assests/images/comments.png" title="Content" alt="Content" /><a href="/2017/12/a-look-at-traffic-encryption-options/#disqus_thread">Comments</a></span>
            
                <ul class="categories">
                <li><a href='/tag/network'>Network</a></li><li><a href='/tag/security'>Security</a></li></ul>
            
        </div>
        <div class="entry">
            <p>Given a post <a href="/2017/12/a-look-at-low-cost-tap-aggregation/">highlighting the cost effectiveness</a>
of deploying network taps, it would make sense to look at the other side; encryption.</p>

<h1 id="intro">Intro</h1>
<p>It is commonly accepted to use TLS when accessing services over the internet, whether
they are based on HTTP, SMTP, IMAP, POP, FTP or any number of other protocols.</p>

<p>It is also commonly accepted to terminate those TLS connections on the edge,
handling all internal communications in plain text. This is for a number of reasons around scalability, performance and trust.</p>

<p>As technology stacks have matured, a number of security standards have been created,
including those for card handling (PCI DDS); many of these still contain phrasing such
as ‘<a href="https://www.pcisecuritystandards.org/pdfs/pci_ssc_quick_guide.pdf">encrypt transmission of cardholder data across open, public networks</a>’, with the
definitions being open to interpretation.</p>

<p>Pause for a moment and consider if these scenarios are ‘across open, public networks’:</p>

<ul>
  <li>A point to point circuit provided over an external ‘dark fibre’ (DWDM or similar) network</li>
  <li>A point to point wireless link between 2 buildings provided by a 3rd party</li>
  <li>Cross connections between 2 suites within a datacenter, via the meet me room</li>
</ul>

<p>I imagine most people would argue these are private:</p>

<ul>
  <li>All services are dedicated to you</li>
  <li>Traffic is isolated from other customers</li>
  <li>You control both ends of the connection</li>
</ul>

<p>However, there are also risks, as they all pass through physical assets you don’t control:</p>

<ul>
  <li>Traffic interception; it has been widely published that data from the likes of Google has been intercepted and used for profiling activities</li>
  <li>Network access; As with a physical intrusion to your rack/office, it may be possible to gain network access via a cross-connect, or inter-site link, depending on topology</li>
  <li>Redundancy; A targeted attack on physical infrastructure could place your business operations at risk</li>
</ul>

<p>Thankfully, most providers and many ISO standards have well defined physical access controls,
which limit the possibilities of the above however that isn’t very effective against a nation-state,
or a cyber-based attack on a provider.</p>

<p>Many businesses have a wealth of information useful to a nation-state, from habits and preferences
to medical or travel data. It might be paranoia until they’re out to get you.</p>

<p>Ultimately this comes down to risk management and if you want to be ‘compliant’ or ‘secure’
in regards to your customer’s data.</p>

<p>Assuming we want to encrypt data end-to-end, let’s look at the technologies available.</p>

<h1 id="tls">TLS</h1>
<p>As briefly noted above, the standard for encryption in the public network space is
<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a>
(TLS).</p>

<p>There are multiple implementations of TLS, with 1.2 currently being the standard (1.3 is in draft),
the version and associated cryptographic ciphers are usually associated with the
support requirements; many older browsers and SSL libraries don’t support the most
secure choices.</p>

<p>A good starting point is the excellent <a href="https://cipherli.st/">cipherli.st</a> site,
highlighting secure configs for most platforms.</p>

<p>The results should then be checked, either using <code>openssl s_client</code>,
<a href="https://www.ssllabs.com/">ssllabs.com</a> or similar.</p>

<p>Generally, user-facing TLS is simple to deploy, with the potential for
small compatibility issues (including breaking certain browsers).</p>

<p>The direction for <a href="https://security.googleblog.com/2016/09/moving-towards-more-secure-web.html">Google Chrome</a> and others is to start displaying HTTP sites in
the same manner as invalid SSL is currently shown (red bars or similar), so it’s
highly advisable even if you don’t transmit any ‘sensitive info’ (sensitive here
 includes tracking data, such as cookies).</p>

<p>What about the cost? Platforms such as Lets Encrypt provide free SSL certs,
trusted by all major browsers. For dedicated extended validation certificates,
a few hundred dollars is a small cost for most online businesses.</p>

<h2 id="tls-internally">TLS internally</h2>

<p>Historically concerns about the performance of TLS have stunted the deployment internally,
modern versions of the libraries combined with the current generations of CPUs mean
TLS is not slow! (mostly).</p>

<p>The excellent <a href="https://istlsfastyet.com/">istlsfastyet.com</a> goes into detail about
the current state of TLS performance. The key takeaway is, when configured
correctly, TLS at the scale of Facebook and Google performs fast enough with minimal
CPU overhead.</p>

<p>Using the most secure cipher suites (ECDHE) are a little more costly, but with mitigations in place
(HTTP keepalives, session resumption etc), the performance overhead is negligible.</p>

<p>Depending on your environment, you may purchase or use CA-signed certificates
as is the case with external traffic however at a certain scale an internal
certificate authority makes sense.</p>

<p>There is a certain level of complexity in deploying and maintaining a secure
internal certificate authority and many tools exist to help with this.</p>

<p>Another advantage of an internal CA is being able to use certificate-based
authentication for clients, enabling devices to prove their identity.</p>

<h1 id="alternatives">Alternatives</h1>
<p>Depending on your environment, encrypting all inter-device traffic with TLS may
be possible.</p>

<p>Given a small load balanced LAMP stack this should be relatively easy:</p>

<ul>
  <li>TLS from the user to the load balancer</li>
  <li>TLS from the load balancer to the web server</li>
  <li>TLS from PHP to MySQL</li>
</ul>

<p>However, the number of services can easily spiral, given the example above
we could easily have:</p>

<ul>
  <li>SMTP relays</li>
  <li>Memcache/Redis caching</li>
  <li>NFS based storage</li>
  <li>Monitoring agents</li>
</ul>

<p>You may also have services which don’t support TLS:</p>

<ul>
  <li>RADIUS</li>
  <li>Windows Distributed File Shares</li>
  <li>Access control / CCTV systems designed for closed networks</li>
</ul>

<p>There are 2 areas to consider here:</p>

<ul>
  <li>Traffic passing over your network (Physical access restrictions in place)</li>
  <li>Traffic passing over external infrastructure</li>
</ul>

<p>For the first case:</p>

<ul>
  <li>I strongly suggest to deploy TLS where possible, at worst, it is another layer of
defence should a malicious device get into the network.</li>
  <li>For protocols lacking encryption support, their risk is likely low
    <ul>
      <li>If their risk is not low, I’d suggest re-evaluating the technology choice</li>
      <li>Inline encryption is possible but complicated to scale at this level</li>
    </ul>
  </li>
</ul>

<p>For the second, we have a number of options described below.</p>

<h3 id="layer-1-encryption">Layer 1 encryption</h3>
<p>There are a number of ‘black box’ solutions, which sit in-line to the network.</p>

<p>The general principle is un-encrypted data comes in one end, encrypted data comes
out the other; the reverse then happens to give you un-encrypted data on the other end.</p>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: layer 1 encryption Pages: 1 -->
<svg role="img" aria-label="layer 1 encryption" width="563pt" height="99pt" viewBox="0.00 0.00 562.66 99.00">
<title>layer 1 encryption</title>
<desc>digraph &quot;layer 1 encryption&quot; {

rankdir=LR;
subgraph cluster_SiteA {
  label = &quot;Site A&quot;;
  color = black;
  &quot;Router A&quot;;
}
subgraph cluster_EncryptedNet {
  label = &quot;Encrypted Network&quot;;
  color = red;
  &quot;Device A&quot;;
  &quot;Device B&quot;;
}
subgraph cluster_SiteB {
  label = &quot;Site B&quot;;
  color = black;
  &quot;Router B&quot;;
}
&quot;Router A&quot; -&gt; &quot;Device A&quot;
&quot;Device A&quot; -&gt; &quot;Device B&quot;
&quot;Device B&quot; -&gt; &quot;Router B&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 95)">
<title>layer 1 encryption</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-95 558.66,-95 558.66,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_SiteA</title>
<polygon fill="none" stroke="black" points="8,-8 8,-83 127.99,-83 127.99,-8 8,-8" />
<text text-anchor="middle" x="68" y="-67.8" font-family="Times,serif" font-size="14.00">Site A</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_EncryptedNet</title>
<polygon fill="none" stroke="red" points="147.99,-8 147.99,-83 406.67,-83 406.67,-8 147.99,-8" />
<text text-anchor="middle" x="277.33" y="-67.8" font-family="Times,serif" font-size="14.00">Encrypted Network</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_SiteB</title>
<polygon fill="none" stroke="black" points="426.67,-8 426.67,-83 546.66,-83 546.66,-8 426.67,-8" />
<text text-anchor="middle" x="486.67" y="-67.8" font-family="Times,serif" font-size="14.00">Site B</text>
</g>
<!-- Router A -->
<g id="node1" class="node">
<title>Router A</title>
<ellipse fill="none" stroke="black" cx="68" cy="-34" rx="51.99" ry="18" />
<text text-anchor="middle" x="68" y="-30.3" font-family="Times,serif" font-size="14.00">Router A</text>
</g>
<!-- Device A -->
<g id="node2" class="node">
<title>Device A</title>
<ellipse fill="none" stroke="black" cx="207.34" cy="-34" rx="51.19" ry="18" />
<text text-anchor="middle" x="207.34" y="-30.3" font-family="Times,serif" font-size="14.00">Device A</text>
</g>
<!-- Router A&#45;&gt;Device A -->
<g id="edge1" class="edge">
<title>Router A&#45;&gt;Device A</title>
<path fill="none" stroke="black" d="M120.14,-34C128.38,-34 136.98,-34 145.42,-34" />
<polygon fill="black" stroke="black" points="145.61,-37.5 155.61,-34 145.61,-30.5 145.61,-37.5" />
</g>
<!-- Device B -->
<g id="node3" class="node">
<title>Device B</title>
<ellipse fill="none" stroke="black" cx="346.68" cy="-34" rx="51.99" ry="18" />
<text text-anchor="middle" x="346.68" y="-30.3" font-family="Times,serif" font-size="14.00">Device B</text>
</g>
<!-- Device A&#45;&gt;Device B -->
<g id="edge2" class="edge">
<title>Device A&#45;&gt;Device B</title>
<path fill="none" stroke="black" d="M258.7,-34C266.97,-34 275.63,-34 284.13,-34" />
<polygon fill="black" stroke="black" points="284.4,-37.5 294.4,-34 284.4,-30.5 284.4,-37.5" />
</g>
<!-- Router B -->
<g id="node4" class="node">
<title>Router B</title>
<ellipse fill="none" stroke="black" cx="486.67" cy="-34" rx="51.99" ry="18" />
<text text-anchor="middle" x="486.67" y="-30.3" font-family="Times,serif" font-size="14.00">Router B</text>
</g>
<!-- Device B&#45;&gt;Router B -->
<g id="edge3" class="edge">
<title>Device B&#45;&gt;Router B</title>
<path fill="none" stroke="black" d="M399.06,-34C407.23,-34 415.76,-34 424.13,-34" />
<polygon fill="black" stroke="black" points="424.24,-37.5 434.24,-34 424.24,-30.5 424.24,-37.5" />
</g>
</g>
</svg>
</div>

<p>These are generally expensive appliances, licensed by port or bandwidth capability.
They are also generally completely closed boxes, operating strictly at layer 1.</p>

<p>Deployed across DWDM or similar networks, these devices should ‘just work’ and provide
full encryption (layer 1 to 7). They are limited to ‘point to point’ links.</p>

<p>A side effect of the point to point encryption is the prevention of unauthorised traffic.</p>

<h3 id="ieee-8021ae-macsec">IEEE 802.1AE (MacSec)</h3>
<p>A more open and industry standard approach would be to deploy MacSec.</p>

<p>MacSec provides encryption of the layer 2 header and up, but leaves the src/dest
mac addresses exposed.</p>

<p>It operates similar to an Ethernet frame within a layer 2 network, with the
packets containing 4 fields</p>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: macsec header Pages: 1 -->
<svg role="img" aria-label="macsec header" width="706pt" height="178pt" viewBox="0.00 0.00 706.00 178.00">
<title>macsec header</title>
<desc>digraph &quot;macsec header&quot; {

subgraph cluster {
  rankdir=LR;
  height=1.5;
  &quot;Destination MAC&quot; [shape=square, height=1.5];
  &quot;Source MAC&quot; [shape=square, height=1.5];
  &quot;Security TAG&quot; [shape=square, height=1.5];
  &quot;Encrypted Data&quot; [shape=square, height=1.5];
  &quot;ICV&quot; [shape=square, height=1.5];
}

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 174)">
<title>macsec header</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-174 702,-174 702,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-162 690,-162 690,-8 8,-8" />
</g>
<!-- Destination MAC -->
<g id="node1" class="node">
<title>Destination MAC</title>
<polygon fill="none" stroke="black" points="682,-154 544,-154 544,-16 682,-16 682,-154" />
<text text-anchor="middle" x="613" y="-81.3" font-family="Times,serif" font-size="14.00">Destination MAC</text>
</g>
<!-- Source MAC -->
<g id="node2" class="node">
<title>Source MAC</title>
<polygon fill="none" stroke="black" points="526,-139 418,-139 418,-31 526,-31 526,-139" />
<text text-anchor="middle" x="472" y="-81.3" font-family="Times,serif" font-size="14.00">Source MAC</text>
</g>
<!-- Security TAG -->
<g id="node3" class="node">
<title>Security TAG</title>
<polygon fill="none" stroke="black" points="400,-140 290,-140 290,-30 400,-30 400,-140" />
<text text-anchor="middle" x="345" y="-81.3" font-family="Times,serif" font-size="14.00">Security TAG</text>
</g>
<!-- Encrypted Data -->
<g id="node4" class="node">
<title>Encrypted Data</title>
<polygon fill="none" stroke="black" points="271.5,-149.5 142.5,-149.5 142.5,-20.5 271.5,-20.5 271.5,-149.5" />
<text text-anchor="middle" x="207" y="-81.3" font-family="Times,serif" font-size="14.00">Encrypted Data</text>
</g>
<!-- ICV -->
<g id="node5" class="node">
<title>ICV</title>
<polygon fill="none" stroke="black" points="124,-139 16,-139 16,-31 124,-31 124,-139" />
<text text-anchor="middle" x="70" y="-81.3" font-family="Times,serif" font-size="14.00">ICV</text>
</g>
</g>
</svg>
</div>

<p>Any layer 2 data outside of the mac addresses (VLAN tag, LLDP etc) is contained
within the encrypted data.</p>

<p>The security tag and ICV are used internally for MacSec, with the mac addresses being
used for forwarding.</p>

<p>There is a hardware dependency associated with MacSec, as the encryption is done
in hardware to achieve line rate speeds. This varies between vendors but can
be in the form of dedicated line cards or whole products.</p>

<p>It is possible to offload the encryption to MacSec capable switches,
allowing routers and line cards to remain, with the switch sitting inline.</p>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: macsec encryption Pages: 1 -->
<svg role="img" aria-label="macsec encryption" width="564pt" height="99pt" viewBox="0.00 0.00 563.96 99.00">
<title>macsec encryption</title>
<desc>digraph &quot;macsec encryption&quot; {

rankdir=LR;
subgraph cluster_SiteA {
  label = &quot;Site A&quot;;
  color = black;
  &quot;Router A&quot;;
}
subgraph cluster_EncryptedNet {
  label = &quot;Encrypted Network&quot;;
  color = red;
  &quot;Switch A&quot;;
  &quot;Switch B&quot;;
}
subgraph cluster_SiteB {
  label = &quot;Site B&quot;;
  color = black;
  &quot;Router B&quot;;
}
&quot;Router A&quot; -&gt; &quot;Switch A&quot;
&quot;Switch A&quot; -&gt; &quot;Switch B&quot;
&quot;Switch B&quot; -&gt; &quot;Router B&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 95)">
<title>macsec encryption</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-95 559.96,-95 559.96,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_SiteA</title>
<polygon fill="none" stroke="black" points="8,-8 8,-83 127.99,-83 127.99,-8 8,-8" />
<text text-anchor="middle" x="68" y="-67.8" font-family="Times,serif" font-size="14.00">Site A</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_EncryptedNet</title>
<polygon fill="none" stroke="red" points="147.99,-8 147.99,-83 407.97,-83 407.97,-8 147.99,-8" />
<text text-anchor="middle" x="277.98" y="-67.8" font-family="Times,serif" font-size="14.00">Encrypted Network</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_SiteB</title>
<polygon fill="none" stroke="black" points="427.97,-8 427.97,-83 547.96,-83 547.96,-8 427.97,-8" />
<text text-anchor="middle" x="487.97" y="-67.8" font-family="Times,serif" font-size="14.00">Site B</text>
</g>
<!-- Router A -->
<g id="node1" class="node">
<title>Router A</title>
<ellipse fill="none" stroke="black" cx="68" cy="-34" rx="51.99" ry="18" />
<text text-anchor="middle" x="68" y="-30.3" font-family="Times,serif" font-size="14.00">Router A</text>
</g>
<!-- Switch A -->
<g id="node2" class="node">
<title>Switch A</title>
<ellipse fill="none" stroke="black" cx="207.99" cy="-34" rx="51.99" ry="18" />
<text text-anchor="middle" x="207.99" y="-30.3" font-family="Times,serif" font-size="14.00">Switch A</text>
</g>
<!-- Router A&#45;&gt;Switch A -->
<g id="edge1" class="edge">
<title>Router A&#45;&gt;Switch A</title>
<path fill="none" stroke="black" d="M120.38,-34C128.55,-34 137.07,-34 145.45,-34" />
<polygon fill="black" stroke="black" points="145.56,-37.5 155.56,-34 145.56,-30.5 145.56,-37.5" />
</g>
<!-- Switch B -->
<g id="node3" class="node">
<title>Switch B</title>
<ellipse fill="none" stroke="black" cx="347.98" cy="-34" rx="51.99" ry="18" />
<text text-anchor="middle" x="347.98" y="-30.3" font-family="Times,serif" font-size="14.00">Switch B</text>
</g>
<!-- Switch A&#45;&gt;Switch B -->
<g id="edge2" class="edge">
<title>Switch A&#45;&gt;Switch B</title>
<path fill="none" stroke="black" d="M260.37,-34C268.54,-34 277.07,-34 285.44,-34" />
<polygon fill="black" stroke="black" points="285.55,-37.5 295.55,-34 285.55,-30.5 285.55,-37.5" />
</g>
<!-- Router B -->
<g id="node4" class="node">
<title>Router B</title>
<ellipse fill="none" stroke="black" cx="487.97" cy="-34" rx="51.99" ry="18" />
<text text-anchor="middle" x="487.97" y="-30.3" font-family="Times,serif" font-size="14.00">Router B</text>
</g>
<!-- Switch B&#45;&gt;Router B -->
<g id="edge3" class="edge">
<title>Switch B&#45;&gt;Router B</title>
<path fill="none" stroke="black" d="M400.36,-34C408.53,-34 417.06,-34 425.43,-34" />
<polygon fill="black" stroke="black" points="425.54,-37.5 435.54,-34 425.54,-30.5 425.54,-37.5" />
</g>
</g>
</svg>
</div>

<p>It may not be desirable to put a layer 2 device in your path, though it is
likely that the path will already be using BFD or similar to account for
any provider interruptions, which don’t result in an interface flap.</p>

<p>There are also some implementation considerations:</p>

<ul>
  <li>Additional header size needs to be accounted for in downstream MTUs</li>
  <li>Certain providers filter layer 2 traffic, they may filter the MacSec control messages!</li>
</ul>

<p>As with Layer 1 encryption, this prevents unauthorised traffic entering the network, as
well as protecting against interception.</p>

<h3 id="dmvpn--mesh-vpn">DMVPN / Mesh VPN</h3>
<p>It may be desirable in some cases to form a software-based VPN mesh over
your existing network, providing encryption between 2 or more points.</p>

<p>This could be in the form of a single IPsec tunnel, or a complex hub-spoke DMVPN
network. These could be deployed on dedicated devices or end-user devices.</p>

<p>For high traffic applications, these approaches are likely not applicable, due to
line rate speeds being desirable, but in branch or remote worker applications
they can be powerful options in your toolbox.</p>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: vpn mesh encryption Pages: 1 -->
<svg role="img" aria-label="vpn mesh encryption" width="809pt" height="214pt" viewBox="0.00 0.00 809.34 213.65">
<title>vpn mesh encryption</title>
<desc>digraph &quot;vpn mesh encryption&quot; {

rankdir=LR;
&quot;Device A&quot; -&gt; &quot;Device B&quot;
&quot;Device A&quot; -&gt; &quot;Device C&quot;
&quot;Device A&quot; -&gt; &quot;Device D&quot;
&quot;Device A&quot; -&gt; &quot;Device E&quot;
&quot;Device A&quot; -&gt; &quot;Device F&quot;

&quot;Device B&quot; -&gt; &quot;Device C&quot;
&quot;Device B&quot; -&gt; &quot;Device D&quot;
&quot;Device B&quot; -&gt; &quot;Device E&quot;
&quot;Device B&quot; -&gt; &quot;Device F&quot;

&quot;Device C&quot; -&gt; &quot;Device D&quot;
&quot;Device C&quot; -&gt; &quot;Device E&quot;
&quot;Device C&quot; -&gt; &quot;Device F&quot;

&quot;Device D&quot; -&gt; &quot;Device E&quot;
&quot;Device D&quot; -&gt; &quot;Device F&quot;

&quot;Device E&quot; -&gt; &quot;Device F&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 209.65)">
<title>vpn mesh encryption</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-209.65 805.34,-209.65 805.34,4 -4,4" />
<!-- Device A -->
<g id="node1" class="node">
<title>Device A</title>
<ellipse fill="none" stroke="black" cx="51.35" cy="-90.65" rx="51.19" ry="18" />
<text text-anchor="middle" x="51.35" y="-86.95" font-family="Times,serif" font-size="14.00">Device A</text>
</g>
<!-- Device B -->
<g id="node2" class="node">
<title>Device B</title>
<ellipse fill="none" stroke="black" cx="190.69" cy="-90.65" rx="51.99" ry="18" />
<text text-anchor="middle" x="190.69" y="-86.95" font-family="Times,serif" font-size="14.00">Device B</text>
</g>
<!-- Device A&#45;&gt;Device B -->
<g id="edge1" class="edge">
<title>Device A&#45;&gt;Device B</title>
<path fill="none" stroke="black" d="M102.71,-90.65C110.98,-90.65 119.63,-90.65 128.14,-90.65" />
<polygon fill="black" stroke="black" points="128.41,-94.15 138.41,-90.65 128.41,-87.15 128.41,-94.15" />
</g>
<!-- Device C -->
<g id="node3" class="node">
<title>Device C</title>
<ellipse fill="none" stroke="black" cx="330.68" cy="-159.65" rx="51.99" ry="18" />
<text text-anchor="middle" x="330.68" y="-155.95" font-family="Times,serif" font-size="14.00">Device C</text>
</g>
<!-- Device A&#45;&gt;Device C -->
<g id="edge2" class="edge">
<title>Device A&#45;&gt;Device C</title>
<path fill="none" stroke="black" d="M89.12,-102.92C104.37,-107.81 122.3,-113.29 138.69,-117.65 184.32,-129.78 236.74,-141.12 275.1,-148.96" />
<polygon fill="black" stroke="black" points="274.54,-152.42 285.03,-150.97 275.93,-145.56 274.54,-152.42" />
</g>
<!-- Device D -->
<g id="node4" class="node">
<title>Device D</title>
<ellipse fill="none" stroke="black" cx="470.67" cy="-41.65" rx="51.99" ry="18" />
<text text-anchor="middle" x="470.67" y="-37.95" font-family="Times,serif" font-size="14.00">Device D</text>
</g>
<!-- Device A&#45;&gt;Device D -->
<g id="edge3" class="edge">
<title>Device A&#45;&gt;Device D</title>
<path fill="none" stroke="black" d="M87.59,-77.66C103.07,-72.47 121.57,-66.96 138.69,-63.65 231.41,-45.75 341.14,-41.75 408.06,-41.2" />
<polygon fill="black" stroke="black" points="408.44,-44.69 418.42,-41.13 408.4,-37.69 408.44,-44.69" />
</g>
<!-- Device E -->
<g id="node5" class="node">
<title>Device E</title>
<ellipse fill="none" stroke="black" cx="610.66" cy="-41.65" rx="51.99" ry="18" />
<text text-anchor="middle" x="610.66" y="-37.95" font-family="Times,serif" font-size="14.00">Device E</text>
</g>
<!-- Device A&#45;&gt;Device E -->
<g id="edge4" class="edge">
<title>Device A&#45;&gt;Device E</title>
<path fill="none" stroke="black" d="M77.19,-75.08C94.01,-65.13 117.02,-52.65 138.69,-44.65 256.61,-1.11 293.04,-8.69 418.67,-4.65 464.87,-3.17 477.38,4.58 522.66,-4.65 539.84,-8.15 557.83,-15.18 572.97,-22.17" />
<polygon fill="black" stroke="black" points="571.46,-25.33 581.99,-26.49 574.48,-19.01 571.46,-25.33" />
</g>
<!-- Device F -->
<g id="node6" class="node">
<title>Device F</title>
<ellipse fill="none" stroke="black" cx="750" cy="-125.65" rx="51.19" ry="18" />
<text text-anchor="middle" x="750" y="-121.95" font-family="Times,serif" font-size="14.00">Device F</text>
</g>
<!-- Device A&#45;&gt;Device F -->
<g id="edge5" class="edge">
<title>Device A&#45;&gt;Device F</title>
<path fill="none" stroke="black" d="M74.42,-106.88C119.77,-138.58 227.78,-205.65 329.68,-205.65 329.68,-205.65 329.68,-205.65 471.67,-205.65 559.65,-205.65 657.4,-168.02 710.13,-144.38" />
<polygon fill="black" stroke="black" points="711.79,-147.47 719.44,-140.14 708.89,-141.1 711.79,-147.47" />
</g>
<!-- Device B&#45;&gt;Device C -->
<g id="edge6" class="edge">
<title>Device B&#45;&gt;Device C</title>
<path fill="none" stroke="black" d="M221.29,-105.45C241.66,-115.64 268.92,-129.27 291.01,-140.32" />
<polygon fill="black" stroke="black" points="289.61,-143.53 300.12,-144.87 292.74,-137.27 289.61,-143.53" />
</g>
<!-- Device B&#45;&gt;Device D -->
<g id="edge7" class="edge">
<title>Device B&#45;&gt;Device D</title>
<path fill="none" stroke="black" d="M237.28,-82.61C285.65,-74.09 362.12,-60.61 414.02,-51.46" />
<polygon fill="black" stroke="black" points="414.81,-54.88 424.05,-49.69 413.6,-47.98 414.81,-54.88" />
</g>
<!-- Device B&#45;&gt;Device E -->
<g id="edge8" class="edge">
<title>Device B&#45;&gt;Device E</title>
<path fill="none" stroke="black" d="M221.85,-76.17C238.39,-68.56 259.4,-59.44 278.68,-52.65 382.2,-16.21 414.16,1.8 522.66,-14.65 536.88,-16.81 551.97,-20.84 565.53,-25.14" />
<polygon fill="black" stroke="black" points="564.5,-28.48 575.09,-28.3 566.69,-21.84 564.5,-28.48" />
</g>
<!-- Device B&#45;&gt;Device F -->
<g id="edge9" class="edge">
<title>Device B&#45;&gt;Device F</title>
<path fill="none" stroke="black" d="M242.13,-93.82C344.92,-100.27 578.23,-114.93 688.77,-121.87" />
<polygon fill="black" stroke="black" points="688.87,-125.38 699.07,-122.52 689.31,-118.4 688.87,-125.38" />
</g>
<!-- Device C&#45;&gt;Device D -->
<g id="edge10" class="edge">
<title>Device C&#45;&gt;Device D</title>
<path fill="none" stroke="black" d="M347.04,-142.36C363.69,-124.14 391.54,-95.15 418.67,-73.65 423.45,-69.87 428.69,-66.15 433.95,-62.66" />
<polygon fill="black" stroke="black" points="436.19,-65.38 442.71,-57.03 432.41,-59.49 436.19,-65.38" />
</g>
<!-- Device C&#45;&gt;Device E -->
<g id="edge11" class="edge">
<title>Device C&#45;&gt;Device E</title>
<path fill="none" stroke="black" d="M364.38,-145.77C414.99,-124.29 512.22,-83.01 567.86,-59.4" />
<polygon fill="black" stroke="black" points="569.24,-62.61 577.08,-55.48 566.51,-56.17 569.24,-62.61" />
</g>
<!-- Device C&#45;&gt;Device F -->
<g id="edge12" class="edge">
<title>Device C&#45;&gt;Device F</title>
<path fill="none" stroke="black" d="M382.56,-158.16C447.66,-155.89 563.82,-150.62 662.65,-139.65 672.73,-138.53 683.42,-137.05 693.72,-135.46" />
<polygon fill="black" stroke="black" points="694.53,-138.87 703.86,-133.85 693.43,-131.96 694.53,-138.87" />
</g>
<!-- Device D&#45;&gt;Device E -->
<g id="edge13" class="edge">
<title>Device D&#45;&gt;Device E</title>
<path fill="none" stroke="black" d="M523.05,-41.65C531.22,-41.65 539.75,-41.65 548.12,-41.65" />
<polygon fill="black" stroke="black" points="548.23,-45.15 558.23,-41.65 548.23,-38.15 548.23,-45.15" />
</g>
<!-- Device D&#45;&gt;Device F -->
<g id="edge14" class="edge">
<title>Device D&#45;&gt;Device F</title>
<path fill="none" stroke="black" d="M509.75,-53.56C524.96,-58.29 542.63,-63.76 558.66,-68.65 606.82,-83.34 661.94,-99.8 700.42,-111.25" />
<polygon fill="black" stroke="black" points="699.74,-114.7 710.32,-114.19 701.74,-107.99 699.74,-114.7" />
</g>
<!-- Device E&#45;&gt;Device F -->
<g id="edge15" class="edge">
<title>Device E&#45;&gt;Device F</title>
<path fill="none" stroke="black" d="M637.17,-57.25C659.04,-70.63 690.74,-90.02 714.81,-104.74" />
<polygon fill="black" stroke="black" points="713.27,-107.9 723.63,-110.13 716.92,-101.93 713.27,-107.9" />
</g>
</g>
</svg>
</div>

<h1 id="summary">Summary</h1>
<p>There is not a 1 solution fits all. It is very dependent upon your
environment and more specifically the applications within it.</p>

<p>My advice is to look at the risk in each area, design an appropriate solution and
test it.</p>

<p>A targeted approach keeps things simple to start, but personally, I look to
provide end-to-end encryption everywhere… trusting no one.</p>

<p>If you have no clear areas of risk, start with everywhere you touch the outside
world, either via a public interface or provider managed services.</p>

        </div>
    </article>
    
    <article class="post">
        <h1 class="title"><a href="/2017/12/a-look-at-low-cost-tap-aggregation/">A look at low-cost tap aggregation</a></h1>
        <div class="meta">
            <span><img src="/assests/images/date.png" title="Date" alt="Date" />25 Dec 2017</span>
            <span><img src="/assests/images/comments.png" title="Content" alt="Content" /><a href="/2017/12/a-look-at-low-cost-tap-aggregation/#disqus_thread">Comments</a></span>
            
                <ul class="categories">
                <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/python'>Python</a></li></ul>
            
        </div>
        <div class="entry">
            <p>A while ago, I had a project that required capturing traffic from a
number of sources, thus an adventure into possible solutions was born.</p>

<h2 id="why-do-we-want-to-capture-traffic">Why do we want to capture traffic?</h2>

<p>There are numerous reasons to capture traffic including:</p>

<ul>
  <li>Network troubleshooting</li>
  <li>Traffic monitoring (including intrusion detection)</li>
  <li>Legal requests/requirements</li>
</ul>

<p>Ultimately it’s about getting visibility, either for security or operations.</p>

<p>Our goal is given any path, to be able to replicate the traffic, with minimal impact.</p>

<h2 id="how-can-we-capture-traffic">How can we capture traffic?</h2>

<p>There are generally 3 different methods for capturing traffic, each with their
own complexities.</p>

<h3 id="from-a-target-device">From a target device</h3>
<p>At a basic level, a device can capture traffic in 2 ways:</p>

<ul>
  <li>‘CPU bound’; traffic that has been brought up the network stack and is ‘destined’ for this device</li>
  <li>Raw sockets; ‘raw’ network traffic that the device receives on a network interface.</li>
</ul>

<p>CPU bound traffic can be efficient to capture if filtered appropriately. When dealing with high
traffic volumes processing traffic can take critical resources away from your business applications.</p>

<p>Raw sockets are generally very limited, hub-based topologies are not widely used, limiting any traffic to broadcast for the servers subnet, or targeted (CPU bound) traffic (multicast/unicast).</p>

<p>Generally, to be usable by an analyser the traffic would need to be encapsulated and transmitted,
using further resources on the device.</p>

<h3 id="span-a-switch">Span a switch</h3>
<p>This is similar to inline, but I’ve separated it here due to implementation differences.</p>

<p>SPAN’s generally come in 3 forms:</p>

<ul>
  <li>SPAN - take traffic from port A, mirror to port B, on the same device</li>
  <li>RSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 2)</li>
  <li>ERSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 3)</li>
</ul>

<p>There are a number of downsides:</p>

<ul>
  <li>Vendors have varying levels of support;
    <ul>
      <li>RSPAN on a Juniper EX series switch doesn’t work over an AE</li>
      <li>Tricks can be used, for example, spanning into a GRE tunnel to accomplish ERSPAN, this becomes hardware dependent though</li>
    </ul>
  </li>
  <li>CPU generated (ICMP/ARP/LLDP/BPDU etc) packets generally do not get mirrored</li>
  <li>Invalid packets will not be seen (those dropped due to checksum errors for example)</li>
  <li>CPU usage can increase drastically due to extra processing requirements</li>
  <li>As we’re spanning in an L2 domain arp table churn can happen if you’re not careful</li>
</ul>

<p>However, if you need insight into a switched domain and don’t want to inline-tap every cable,
it might work for you.</p>

<h3 id="inline">Inline</h3>
<p>Inline-taps come in many different flavours, supporting different media types. At a basic level, there are 2 main differences.</p>

<h4 id="passive-tap">Passive tap</h4>
<ul>
  <li>Require no power, pass the original signal onto the output</li>
  <li>Reduce the output power by a known ratio (important when dealing with fibre)</li>
  <li>No monitoring data or other insights possible</li>
  <li>Very failure resistant</li>
</ul>

<h5 id="logical-operation">Logical operation</h5>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: passive tap Pages: 1 -->
<svg role="img" aria-label="passive tap" width="542pt" height="207pt" viewBox="0.00 0.00 542.00 206.95">
<title>passive tap</title>
<desc>digraph &quot;passive tap&quot; {

subgraph cluster_Input {
  label = &quot;Input Port&quot;;
    color = black;
  &quot;Input TX&quot;;
  &quot;Input RX&quot;;
}
subgraph cluster_Output {
  label = &quot;Output Port&quot;;
    color = black;
  &quot;Output TX&quot;;
  &quot;Output RX&quot;;
}
subgraph cluster_Monitor {
  label = &quot;Monitor Port&quot;;
    color = black;
  &quot;Monitor TX2&quot;;
  &quot;Monitor TX1&quot;;
}
&quot;Input TX&quot; -&gt; &quot;Output RX&quot;
&quot;Input TX&quot; -&gt; &quot;Monitor TX1&quot;
&quot;Output TX&quot; -&gt; &quot;Input RX&quot;
&quot;Output TX&quot; -&gt; &quot;Monitor TX2&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 202.95)">
<title>passive tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-202.95 538,-202.95 538,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_Input</title>
<polygon fill="none" stroke="black" points="8,-91 8,-166 248,-166 248,-91 8,-91" />
<text text-anchor="middle" x="128" y="-150.8" font-family="Times,serif" font-size="14.00">Input Port</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Output</title>
<polygon fill="none" stroke="black" points="256,-91 256,-166 526,-166 526,-91 256,-91" />
<text text-anchor="middle" x="391" y="-150.8" font-family="Times,serif" font-size="14.00">Output Port</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Monitor</title>
<polygon fill="none" stroke="black" points="164,-8 164,-83 474,-83 474,-8 164,-8" />
<text text-anchor="middle" x="319" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text>
</g>
<!-- Input TX -->
<g id="node1" class="node">
<title>Input TX</title>
<ellipse fill="none" stroke="black" cx="189" cy="-117" rx="50.89" ry="18" />
<text text-anchor="middle" x="189" y="-113.3" font-family="Times,serif" font-size="14.00">Input TX</text>
</g>
<!-- Output RX -->
<g id="node4" class="node">
<title>Output RX</title>
<ellipse fill="none" stroke="black" cx="324" cy="-117" rx="59.59" ry="18" />
<text text-anchor="middle" x="324" y="-113.3" font-family="Times,serif" font-size="14.00">Output RX</text>
</g>
<!-- Input TX&#45;&gt;Output RX -->
<g id="edge1" class="edge">
<title>Input TX&#45;&gt;Output RX</title>
<path fill="none" stroke="black" d="M239.89,-117C244.57,-117 249.26,-117 253.94,-117" />
<polygon fill="black" stroke="black" points="254.2,-120.5 264.2,-117 254.2,-113.5 254.2,-120.5" />
</g>
<!-- Monitor TX1 -->
<g id="node6" class="node">
<title>Monitor TX1</title>
<ellipse fill="none" stroke="black" cx="241" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="241" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text>
</g>
<!-- Input TX&#45;&gt;Monitor TX1 -->
<g id="edge2" class="edge">
<title>Input TX&#45;&gt;Monitor TX1</title>
<path fill="none" stroke="black" d="M199.77,-99.22C206.91,-88.1 216.4,-73.32 224.48,-60.73" />
<polygon fill="black" stroke="black" points="227.6,-62.35 230.06,-52.04 221.71,-58.56 227.6,-62.35" />
</g>
<!-- Input RX -->
<g id="node2" class="node">
<title>Input RX</title>
<ellipse fill="none" stroke="black" cx="68" cy="-117" rx="51.99" ry="18" />
<text text-anchor="middle" x="68" y="-113.3" font-family="Times,serif" font-size="14.00">Input RX</text>
</g>
<!-- Output TX -->
<g id="node3" class="node">
<title>Output TX</title>
<ellipse fill="none" stroke="black" cx="460" cy="-117" rx="58.49" ry="18" />
<text text-anchor="middle" x="460" y="-113.3" font-family="Times,serif" font-size="14.00">Output TX</text>
</g>
<!-- Output TX&#45;&gt;Input RX -->
<g id="edge3" class="edge">
<title>Output TX&#45;&gt;Input RX</title>
<path fill="none" stroke="black" d="M446.54,-134.62C432.85,-150.96 410,-174.18 384,-184 332.86,-203.32 188.73,-204.37 138,-184 117.19,-175.65 99.07,-157.82 86.48,-142.66" />
<polygon fill="black" stroke="black" points="89.03,-140.24 80.08,-134.59 83.55,-144.59 89.03,-140.24" />
</g>
<!-- Monitor TX2 -->
<g id="node5" class="node">
<title>Monitor TX2</title>
<ellipse fill="none" stroke="black" cx="397" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="397" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text>
</g>
<!-- Output TX&#45;&gt;Monitor TX2 -->
<g id="edge4" class="edge">
<title>Output TX&#45;&gt;Monitor TX2</title>
<path fill="none" stroke="black" d="M446.95,-99.22C438.08,-87.81 426.19,-72.54 416.25,-59.74" />
<polygon fill="black" stroke="black" points="418.94,-57.51 410.04,-51.76 413.41,-61.8 418.94,-57.51" />
</g>
</g>
</svg>
</div>

<p>There are different technologies for mirroring the payload when using copper, these
are generally resistor based, for fibre they’re either thin film or fused biconical taper based.</p>

<p><em>Note: Thin film is generally preferred for 40G+ links, due to their lower loss rate caused by more even light distribution.</em></p>

<p>The concept for all of them is the same:</p>

<ul>
  <li>Given an input of 100%</li>
  <li>Bleed off x% of the signal to the mirror port</li>
  <li>Pass the remaining 100-x% through to the output port</li>
</ul>

<p>A key consideration when using fibre is the ‘split ratio’ aka how much light to bleed off,
both the monitor and the output interfaces need enough light for the optics on the other end.</p>

<h4 id="active-tap">Active tap</h4>
<ul>
  <li>They require power and re-generate the output signals.</li>
  <li>Monitoring data can be provided (light levels etc)</li>
  <li>When using fibre there are no split ratio considerations</li>
</ul>

<h5 id="logical-operation-1">Logical operation</h5>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: active tap Pages: 1 -->
<svg role="img" aria-label="active tap" width="542pt" height="254pt" viewBox="0.00 0.00 542.00 254.00">
<title>active tap</title>
<desc>digraph &quot;active tap&quot; {

subgraph cluster_Input {
  label = &quot;Input Port&quot;;
    color = black;
  &quot;Input TX&quot;;
  &quot;Input RX&quot;;
}
subgraph cluster_Output {
  label = &quot;Output Port&quot;;
    color = black;
  &quot;Output TX&quot;;
  &quot;Output RX&quot;;
}
subgraph cluster_Monitor {
  label = &quot;Monitor Port&quot;;
    color = black;
  &quot;Monitor TX2&quot;;
  &quot;Monitor TX1&quot;;
}
subgraph cluster_Processor {
  color = black;
  shape = square;
  &quot;Processor&quot;;
}

&quot;Processor&quot; -&gt; &quot;Input TX&quot;
&quot;Input RX&quot; -&gt; &quot;Processor&quot;
&quot;Processor&quot; -&gt; &quot;Output TX&quot;
&quot;Output RX&quot; -&gt; &quot;Processor&quot;
&quot;Processor&quot; -&gt; &quot;Monitor TX1&quot;
&quot;Processor&quot; -&gt; &quot;Monitor TX2&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 250)">
<title>active tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-250 538,-250 538,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_Input</title>
<polygon fill="none" stroke="black" points="8,-163 8,-238 248,-238 248,-163 8,-163" />
<text text-anchor="middle" x="128" y="-222.8" font-family="Times,serif" font-size="14.00">Input Port</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Output</title>
<polygon fill="none" stroke="black" points="256,-163 256,-238 526,-238 526,-163 256,-163" />
<text text-anchor="middle" x="391" y="-222.8" font-family="Times,serif" font-size="14.00">Output Port</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Monitor</title>
<polygon fill="none" stroke="black" points="127,-8 127,-83 437,-83 437,-8 127,-8" />
<text text-anchor="middle" x="282" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_Processor</title>
<polygon fill="none" stroke="black" points="191,-91 191,-143 321,-143 321,-91 191,-91" />
</g>
<!-- Input TX -->
<g id="node1" class="node">
<title>Input TX</title>
<ellipse fill="none" stroke="black" cx="189" cy="-189" rx="50.89" ry="18" />
<text text-anchor="middle" x="189" y="-185.3" font-family="Times,serif" font-size="14.00">Input TX</text>
</g>
<!-- Input RX -->
<g id="node2" class="node">
<title>Input RX</title>
<ellipse fill="none" stroke="black" cx="68" cy="-189" rx="51.99" ry="18" />
<text text-anchor="middle" x="68" y="-185.3" font-family="Times,serif" font-size="14.00">Input RX</text>
</g>
<!-- Processor -->
<g id="node7" class="node">
<title>Processor</title>
<ellipse fill="none" stroke="black" cx="256" cy="-117" rx="56.59" ry="18" />
<text text-anchor="middle" x="256" y="-113.3" font-family="Times,serif" font-size="14.00">Processor</text>
</g>
<!-- Input RX&#45;&gt;Processor -->
<g id="edge2" class="edge">
<title>Input RX&#45;&gt;Processor</title>
<path fill="none" stroke="black" d="M99.86,-174.6C109.21,-170.76 119.48,-166.63 129,-163 155.41,-152.92 185.19,-142.32 209.27,-133.95" />
<polygon fill="black" stroke="black" points="210.57,-137.21 218.87,-130.62 208.28,-130.59 210.57,-137.21" />
</g>
<!-- Output TX -->
<g id="node3" class="node">
<title>Output TX</title>
<ellipse fill="none" stroke="black" cx="460" cy="-189" rx="58.49" ry="18" />
<text text-anchor="middle" x="460" y="-185.3" font-family="Times,serif" font-size="14.00">Output TX</text>
</g>
<!-- Output RX -->
<g id="node4" class="node">
<title>Output RX</title>
<ellipse fill="none" stroke="black" cx="324" cy="-189" rx="59.59" ry="18" />
<text text-anchor="middle" x="324" y="-185.3" font-family="Times,serif" font-size="14.00">Output RX</text>
</g>
<!-- Output RX&#45;&gt;Processor -->
<g id="edge4" class="edge">
<title>Output RX&#45;&gt;Processor</title>
<path fill="none" stroke="black" d="M307.88,-171.41C299.33,-162.61 288.67,-151.63 279.24,-141.92" />
<polygon fill="black" stroke="black" points="281.48,-139.2 272,-134.47 276.46,-144.08 281.48,-139.2" />
</g>
<!-- Monitor TX2 -->
<g id="node5" class="node">
<title>Monitor TX2</title>
<ellipse fill="none" stroke="black" cx="360" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="360" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text>
</g>
<!-- Monitor TX1 -->
<g id="node6" class="node">
<title>Monitor TX1</title>
<ellipse fill="none" stroke="black" cx="204" cy="-34" rx="68.79" ry="18" />
<text text-anchor="middle" x="204" y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text>
</g>
<!-- Processor&#45;&gt;Input TX -->
<g id="edge1" class="edge">
<title>Processor&#45;&gt;Input TX</title>
<path fill="none" stroke="black" d="M240.08,-134.63C231.6,-143.5 221.02,-154.55 211.69,-164.3" />
<polygon fill="black" stroke="black" points="208.93,-162.12 204.54,-171.76 213.98,-166.96 208.93,-162.12" />
</g>
<!-- Processor&#45;&gt;Output TX -->
<g id="edge3" class="edge">
<title>Processor&#45;&gt;Output TX</title>
<path fill="none" stroke="black" d="M294.52,-130.2C322.05,-139.03 359.93,-151.4 393,-163 400.09,-165.49 407.57,-168.19 414.86,-170.88" />
<polygon fill="black" stroke="black" points="414.04,-174.3 424.63,-174.5 416.47,-167.74 414.04,-174.3" />
</g>
<!-- Processor&#45;&gt;Monitor TX2 -->
<g id="edge6" class="edge">
<title>Processor&#45;&gt;Monitor TX2</title>
<path fill="none" stroke="black" d="M276.55,-100C292.11,-87.87 313.7,-71.06 331.03,-57.57" />
<polygon fill="black" stroke="black" points="333.4,-60.15 339.14,-51.25 329.1,-54.63 333.4,-60.15" />
</g>
<!-- Processor&#45;&gt;Monitor TX1 -->
<g id="edge5" class="edge">
<title>Processor&#45;&gt;Monitor TX1</title>
<path fill="none" stroke="black" d="M245.23,-99.22C238.09,-88.1 228.6,-73.32 220.52,-60.73" />
<polygon fill="black" stroke="black" points="223.29,-58.56 214.94,-52.04 217.4,-62.35 223.29,-58.56" />
</g>
</g>
</svg>
</div>

<p>The internal complexity varies, but the principle is:</p>

<ul>
  <li>Given an input of X</li>
  <li>Generate the payload of X into Y and Z</li>
  <li>Transmit Y to the monitor interface</li>
  <li>Transmit Z to the output interface</li>
</ul>

<p>It is possible to buy active taps, with the capability to ‘fail open’ meaning in the event
of a power failure traffic will continue to flow.</p>

<p>I still prefer to use passive taps, which should be as resilient as a fibre patch panel.</p>

<h2 id="why-do-we-want-to-aggregate-it">Why do we want to aggregate it?</h2>
<p>In the most simplistic deployment, we can simply send from the source to the destination:</p>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: one to one tap Pages: 1 -->
<svg role="img" aria-label="one to one tap" width="204pt" height="44pt" viewBox="0.00 0.00 203.89 44.00">
<title>one to one tap</title>
<desc>digraph &quot;one to one tap&quot; {

rankdir=LR;
&quot;TAP&quot; -&gt; &quot;Analyser&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>one to one tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-40 199.89,-40 199.89,4 -4,4" />
<!-- TAP -->
<g id="node1" class="node">
<title>TAP</title>
<ellipse fill="none" stroke="black" cx="28.6" cy="-18" rx="28.7" ry="18" />
<text text-anchor="middle" x="28.6" y="-14.3" font-family="Times,serif" font-size="14.00">TAP</text>
</g>
<!-- Analyser -->
<g id="node2" class="node">
<title>Analyser</title>
<ellipse fill="none" stroke="black" cx="144.54" cy="-18" rx="51.19" ry="18" />
<text text-anchor="middle" x="144.54" y="-14.3" font-family="Times,serif" font-size="14.00">Analyser</text>
</g>
<!-- TAP&#45;&gt;Analyser -->
<g id="edge1" class="edge">
<title>TAP&#45;&gt;Analyser</title>
<path fill="none" stroke="black" d="M57.47,-18C65.23,-18 73.96,-18 82.82,-18" />
<polygon fill="black" stroke="black" points="82.83,-21.5 92.83,-18 82.83,-14.5 82.83,-21.5" />
</g>
</g>
</svg>
</div>

<p>However, there are a number of reasons to have an aggregation step in the middle:</p>

<ul>
  <li>Number of ingress points
    <ul>
      <li>Aggregation of smaller capture points into larger interfaces</li>
      <li>Reduction in rack space required for analysers, servers etc</li>
      <li>Strategic aggregation to reduce physical requirements (fibre, rack space)</li>
    </ul>
  </li>
  <li>Multiple destinations
    <ul>
      <li>Apply filtering logic to save on analyser licensing</li>
      <li>Send traffic to security appliances and network monitoring devices</li>
    </ul>
  </li>
  <li>Apply software logic to capture rules</li>
  <li>Support multiple media types
    <ul>
      <li>Provide longer reach for copper-based taps</li>
      <li>SMF, MMF, XFP, QSFP, Copper support</li>
    </ul>
  </li>
  <li>Single view of traffic
    <ul>
      <li>Certain DPI/IDS appliances require full flows, difficult in ECMP networks</li>
      <li>I don’t recommend this due to the associated scaling issues</li>
    </ul>
  </li>
</ul>

<p>Downsides to having an aggregation step:</p>

<ul>
  <li>Potential congestion issues (we’re taking raw traffic, limited by the sender)</li>
  <li>Single point of failure
    <ul>
      <li>This could be mitigated using layer 1 fibre switches or similar</li>
      <li>It’s for monitoring traffic, so uptime is likely not as critical</li>
    </ul>
  </li>
  <li>Cost</li>
</ul>

<p>Historically TAP aggregation has been a very expensive game, around 2-4k a port!</p>

<p>Thankfully Arista changed that with their 7150 series switch, which supports a tap mode
as well as a ‘DANZ’ software suite for loss/latency monitoring, packet filtering and mirroring.</p>

<p>The DANZ suite is now available on the 7150, 7280E and 7500E series switches from Arista,
opening up options from 1/2U fixed form to 7/11U chassi based deployments.</p>

<p>The 7150 series gives some nice features:</p>

<ul>
  <li>Port density; up to 64 10G ports</li>
  <li>LANZ+ features for micro-burst analysis</li>
  <li>PTP support for packet time stamping</li>
  <li>~350ns latency for all packets</li>
  <li>Multi-port mirroring</li>
  <li>Hitless (ISSU) upgrades</li>
  <li>A ‘normal’ Linux environment and Python based toolset</li>
  <li>You configure it like any other switch!</li>
</ul>

<h2 id="lets-implement-a-solution">Let’s implement a solution!</h2>

<p>We’ll keep it simple with 1 aggregation point, 6 inputs and 2 outputs.
In reality, this could be multiple levels of aggregation.</p>

<p>Inputs:</p>

<ul>
  <li>2 x Passive taps</li>
  <li>2 x SPANs</li>
  <li>2 x Active taps</li>
</ul>

<p>Logical Groups:</p>

<ul>
  <li>Group 1 - Internet</li>
  <li>Group 2 - Corporate</li>
  <li>Group 3 - Regional</li>
</ul>

<p>Outputs:</p>

<ul>
  <li>Bro Network Security Monitor (Internet + Regional only)</li>
  <li>Server (Corporate only)</li>
</ul>

<h3 id="logical-diagram">Logical Diagram</h3>
<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: active tap Pages: 1 -->
<svg role="img" aria-label="active tap" width="1246pt" height="243pt" viewBox="0.00 0.00 1246.00 243.00">
<title>active tap</title>
<desc>digraph &quot;active tap&quot; {

subgraph cluster_PassiveTap {
  label = &quot;Passive Optical Tap&quot;;
    color = black;
  &quot;Transit Provider 1&quot;;
  &quot;Transit Provider 2&quot;;
}
subgraph cluster_Corporate1 {
  label = &quot;Corporate DMZ&quot;;
    color = black;
  &quot;Corporate Spine 1&quot;;
}
subgraph cluster_Corporate2 {
  label = &quot;Corporate DMZ&quot;;
    color = black;
  &quot;Corporate Spine 2&quot;;
}
subgraph cluster_Regional {
  label = &quot;Active TAP&quot;;
    color = black;
  &quot;Wan Provider 1&quot;;
  &quot;Wan Provider 2&quot;;
}
subgraph cluster_7150 {
  color = black;
  shape = square;
  &quot;Tap Switch&quot;;
}
subgraph cluster_Bro {
  color = black;
  shape = square;
  &quot;Bro Network Security Monitor&quot;;
}
subgraph cluster_Server {
  color = black;
  shape = square;
  &quot;Secret Server&quot;;
}

&quot;Transit Provider 1&quot; -&gt; &quot;Tap Switch&quot;
&quot;Transit Provider 2&quot; -&gt; &quot;Tap Switch&quot;
&quot;Corporate Spine 1&quot; -&gt; &quot;Tap Switch&quot;
&quot;Corporate Spine 2&quot; -&gt; &quot;Tap Switch&quot;
&quot;Wan Provider 1&quot; -&gt; &quot;Tap Switch&quot;
&quot;Wan Provider 2&quot; -&gt; &quot;Tap Switch&quot;

&quot;Tap Switch&quot; -&gt; &quot;Bro Network Security Monitor&quot;
&quot;Tap Switch&quot; -&gt; &quot;Secret Server&quot;

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 239)">
<title>active tap</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-239 1242,-239 1242,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_PassiveTap</title>
<polygon fill="none" stroke="black" points="8,-152 8,-227 425,-227 425,-152 8,-152" />
<text text-anchor="middle" x="216.5" y="-211.8" font-family="Times,serif" font-size="14.00">Passive Optical Tap</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Corporate1</title>
<polygon fill="none" stroke="black" points="433,-152 433,-227 641,-227 641,-152 433,-152" />
<text text-anchor="middle" x="537" y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Corporate2</title>
<polygon fill="none" stroke="black" points="649,-152 649,-227 857,-227 857,-152 649,-152" />
<text text-anchor="middle" x="753" y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_Regional</title>
<polygon fill="none" stroke="black" points="865,-152 865,-227 1230,-227 1230,-152 865,-152" />
<text text-anchor="middle" x="1047.5" y="-211.8" font-family="Times,serif" font-size="14.00">Active TAP</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_7150</title>
<polygon fill="none" stroke="black" points="575,-80 575,-132 715,-132 715,-80 575,-80" />
</g>
<g id="clust6" class="cluster">
<title>cluster_Bro</title>
<polygon fill="none" stroke="black" points="360,-8 360,-60 680,-60 680,-8 360,-8" />
</g>
<g id="clust7" class="cluster">
<title>cluster_Server</title>
<polygon fill="none" stroke="black" points="688,-8 688,-60 854,-60 854,-8 688,-8" />
</g>
<!-- Transit Provider 1 -->
<g id="node1" class="node">
<title>Transit Provider 1</title>
<ellipse fill="none" stroke="black" cx="321" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="321" y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 1</text>
</g>
<!-- Tap Switch -->
<g id="node7" class="node">
<title>Tap Switch</title>
<ellipse fill="none" stroke="black" cx="645" cy="-106" rx="61.99" ry="18" />
<text text-anchor="middle" x="645" y="-102.3" font-family="Times,serif" font-size="14.00">Tap Switch</text>
</g>
<!-- Transit Provider 1&#45;&gt;Tap Switch -->
<g id="edge1" class="edge">
<title>Transit Provider 1&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M378.12,-163.53C394.53,-159.73 412.46,-155.64 429,-152 481.93,-140.36 542.33,-127.84 585.77,-118.97" />
<polygon fill="black" stroke="black" points="586.51,-122.39 595.61,-116.97 585.11,-115.54 586.51,-122.39" />
</g>
<!-- Transit Provider 2 -->
<g id="node2" class="node">
<title>Transit Provider 2</title>
<ellipse fill="none" stroke="black" cx="112" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="112" y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 2</text>
</g>
<!-- Transit Provider 2&#45;&gt;Tap Switch -->
<g id="edge2" class="edge">
<title>Transit Provider 2&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M164.63,-162.93C181,-158.94 199.16,-154.89 216,-152 341.71,-130.39 490.05,-117.62 575.25,-111.49" />
<polygon fill="black" stroke="black" points="575.6,-114.97 585.33,-110.77 575.1,-107.99 575.6,-114.97" />
</g>
<!-- Corporate Spine 1 -->
<g id="node3" class="node">
<title>Corporate Spine 1</title>
<ellipse fill="none" stroke="black" cx="537" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="537" y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 1</text>
</g>
<!-- Corporate Spine 1&#45;&gt;Tap Switch -->
<g id="edge3" class="edge">
<title>Corporate Spine 1&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M562.32,-160.59C577.26,-150.9 596.33,-138.55 612.38,-128.14" />
<polygon fill="black" stroke="black" points="614.46,-130.96 620.95,-122.59 610.65,-125.09 614.46,-130.96" />
</g>
<!-- Corporate Spine 2 -->
<g id="node4" class="node">
<title>Corporate Spine 2</title>
<ellipse fill="none" stroke="black" cx="753" cy="-178" rx="95.58" ry="18" />
<text text-anchor="middle" x="753" y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 2</text>
</g>
<!-- Corporate Spine 2&#45;&gt;Tap Switch -->
<g id="edge4" class="edge">
<title>Corporate Spine 2&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M727.68,-160.59C712.74,-150.9 693.67,-138.55 677.62,-128.14" />
<polygon fill="black" stroke="black" points="679.35,-125.09 669.05,-122.59 675.54,-130.96 679.35,-125.09" />
</g>
<!-- Wan Provider 1 -->
<g id="node5" class="node">
<title>Wan Provider 1</title>
<ellipse fill="none" stroke="black" cx="1139" cy="-178" rx="82.59" ry="18" />
<text text-anchor="middle" x="1139" y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 1</text>
</g>
<!-- Wan Provider 1&#45;&gt;Tap Switch -->
<g id="edge5" class="edge">
<title>Wan Provider 1&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M1093.04,-162.86C1078.72,-158.87 1062.8,-154.84 1048,-152 932.3,-129.79 795.66,-117.39 714.9,-111.46" />
<polygon fill="black" stroke="black" points="715.07,-107.97 704.85,-110.74 714.57,-114.95 715.07,-107.97" />
</g>
<!-- Wan Provider 2 -->
<g id="node6" class="node">
<title>Wan Provider 2</title>
<ellipse fill="none" stroke="black" cx="956" cy="-178" rx="82.59" ry="18" />
<text text-anchor="middle" x="956" y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 2</text>
</g>
<!-- Wan Provider 2&#45;&gt;Tap Switch -->
<g id="edge6" class="edge">
<title>Wan Provider 2&#45;&gt;Tap Switch</title>
<path fill="none" stroke="black" d="M906.81,-163.54C892.12,-159.65 875.94,-155.52 861,-152 808.42,-139.61 748.23,-127.22 704.76,-118.58" />
<polygon fill="black" stroke="black" points="705.41,-115.14 694.92,-116.64 704.05,-122.01 705.41,-115.14" />
</g>
<!-- Bro Network Security Monitor -->
<g id="node8" class="node">
<title>Bro Network Security Monitor</title>
<ellipse fill="none" stroke="black" cx="520" cy="-34" rx="152.17" ry="18" />
<text text-anchor="middle" x="520" y="-30.3" font-family="Times,serif" font-size="14.00">Bro Network Security Monitor</text>
</g>
<!-- Tap Switch&#45;&gt;Bro Network Security Monitor -->
<g id="edge7" class="edge">
<title>Tap Switch&#45;&gt;Bro Network Security Monitor</title>
<path fill="none" stroke="black" d="M617.88,-89.81C600.64,-80.16 578.06,-67.51 558.93,-56.8" />
<polygon fill="black" stroke="black" points="560.57,-53.71 550.14,-51.88 557.15,-59.82 560.57,-53.71" />
</g>
<!-- Secret Server -->
<g id="node9" class="node">
<title>Secret Server</title>
<ellipse fill="none" stroke="black" cx="771" cy="-34" rx="75.29" ry="18" />
<text text-anchor="middle" x="771" y="-30.3" font-family="Times,serif" font-size="14.00">Secret Server</text>
</g>
<!-- Tap Switch&#45;&gt;Secret Server -->
<g id="edge8" class="edge">
<title>Tap Switch&#45;&gt;Secret Server</title>
<path fill="none" stroke="black" d="M672.34,-89.81C690.21,-79.88 713.79,-66.78 733.41,-55.88" />
<polygon fill="black" stroke="black" points="735.36,-58.8 742.4,-50.89 731.96,-52.69 735.36,-58.8" />
</g>
</g>
</svg>
</div>

<h3 id="switch-configuration">Switch configuration</h3>
<p>The switch config is where we wire everything together, there are 3 key concepts:</p>

<ul>
  <li>Tap - input</li>
  <li>Tool - output</li>
  <li>Tap Group - logical grouping of TAP ports</li>
</ul>

<p>The configuration is quite simple and
<a href="https://www.arista.com/en/um-eos/eos-section-16-3-tap-aggregation-configuration">well documented</a>.</p>

<p>First, let’s put the switch into tap mode</p>

<pre><code>switch&gt;en
switch#configure terminal
switch(config)#tap aggregation
switch(config-tap-agg)#mode exclusive
</code></pre>

<p>This will place all switch ports into error disabled and enable tap/tool ports.</p>

<p>Next, define our tap ports</p>

<pre><code>switch(config)#interface ethernet 1
switch(config-if-Et1)#description Transit Provider 1
switch(config-if-Et1)#switchport mode tap
switch(config-if-Et1)#switchport tool group INTERNET

switch(config)#interface ethernet 2
switch(config-if-Et2)#description Transit Provider 2
switch(config-if-Et2)#switchport mode tap
switch(config-if-Et2)#switchport tool group INTERNET

switch(config)#interface ethernet 3
switch(config-if-Et3)#description Corporate Spine 1
switch(config-if-Et3)#switchport mode tap
switch(config-if-Et3)#switchport tool group CORPORATE

switch(config)#interface ethernet 4
switch(config-if-Et4)#description Corporate Spine 2
switch(config-if-Et4)#switchport mode tap
switch(config-if-Et4)#switchport tool group CORPORATE

switch(config)#interface ethernet 5
switch(config-if-Et5)#description Wan Provider 1
switch(config-if-Et5)#switchport mode tap
switch(config-if-Et5)#switchport tool group WAN

switch(config)#interface ethernet 6
switch(config-if-Et6)#description Wan Provider 2
switch(config-if-Et6)#switchport mode tap
switch(config-if-Et6)#switchport tool group WAN
</code></pre>

<p>We now have 3 groups with 3 interfaces in each.</p>

<p>Finally, map those groups onto our outputs.</p>

<pre><code>switch(config)#interface ethernet 10
switch(config-if-Et10)#description Bro Network Security Monitor
switch(config-if-Et10)#switchport mode tool
switch(config-if-Et10)#switchport tool group set INTERNET WAN

switch(config)#interface ethernet 11
switch(config-if-Et11)#description Secret Server
switch(config-if-Et11)#switchport mode tool
switch(config-if-Et11)#switchport tool group set CORPORATE
</code></pre>

<p>Et10 + Et11 will now receive any traffic sent to their relevant groups.</p>

<h3 id="advanced-features">Advanced features</h3>
<p>In the demo, we have a static input -&gt; output allocation in real life this can be
software controlled or filter based.</p>

<p>We could also truncate packets to look at only their headers,
potentially useful for encrypted traffic.</p>

<p>A simple traffic steering example is as below:</p>

<ul>
  <li>For traffic coming into Eth1</li>
  <li>Match traffic targeting 8.8.8.8</li>
  <li>Send to tap group GOOGLE_DNS</li>
  <li>Send tap group GOOGLE_DNS to Eth20</li>
</ul>

<pre><code>switch(config)#ip access-list ACL_GOOGLE_DNS
switch(config-acl-ACL_GOOGLE_DNS)#permit ip any 8.8.8.8/32

switch(config)#class-map type tapagg match-any TAP_CLASS_MAP
switch(config-cmap-TAP_CLASS_MAP)#match ip access-group ACL_GOOGLE_DNS

switch(config)#policy-map type tapagg TAP_POLICY
switch(config-pmap-TAP_POLICY)#class TAP_CLASS_MAP
switch(config-pmap-TAP_POLICY-TAP_CLASS_MAP)#set aggregation-group GOOGLE_DNS

switch(config)#interface ethernet 20
switch(config-if-Et20)#description Magic Box
switch(config-if-Et20)#switchport mode tool
switch(config-if-Et20)#switchport tool group set GOOGLE_DNS

switch(config)#interface ethernet1
switch(config-if-Et1)#service-policy type tapagg input TAP_CLASS_MAP
</code></pre>

<p>For software-based control, Arista provides a powerful HTTP API as well as
XMPP client support and ‘on-device’ APIs. The Python eAPI client can be found on
<a href="https://github.com/arista-eosplus/pyeapi">GitHub</a>, with some <a href="https://github.com/arista-eosplus/pyeapi/tree/develop/examples">examples</a>.</p>

<h1 id="summary">Summary</h1>

<p>It is cost effective to deploy tap infrastructure where required.
The offering from Arista is very powerful, allowing flexibility to meet any number
of requirements.</p>

<p>With a number of integration options (JSON API, Python API, XMPP client),
having dynamic tapping capabilities is a nice spanner to have in your toolbox.</p>

<p>And the cost? Basically, about the same as a 10G switch with routing functionality.</p>

<p>Naturally, the cost is varied depending on physical requirements (fibre/copper runs),
port speeds (1/10/25/40/100G) and port count; this is applicable to any switch or
other tap based deployment.</p>

<h2 id="footnote">Footnote</h2>
<p>I would advise any tap deployments to be carefully planned, certain topologies,
such as multi-stage clos networks do not make good tap targets, both due to the number
of links involved and the resulting bandwidth requirements for the TAP infrastructure.</p>

<p>Depending on your goals, tapping at natural points of congestion, such as
the ingress/egress points for your high performance/bandwidth network segments
(transit links, firewalls etc), will likely provide highly useful information at
a vastly reduce capture complexity.</p>

        </div>
    </article>
    
    <article class="post">
        <h1 class="title"><a href="/2017/12/cluebot-wikimedia-labs-setup/">ClueBot Wikimedia Labs Setup</a></h1>
        <div class="meta">
            <span><img src="/assests/images/date.png" title="Date" alt="Date" />24 Dec 2017</span>
            <span><img src="/assests/images/comments.png" title="Content" alt="Content" /><a href="/2017/12/cluebot-wikimedia-labs-setup/#disqus_thread">Comments</a></span>
            
                <ul class="categories">
                <li><a href='/tag/general'>General</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/foss'>FOSS</a></li></ul>
            
        </div>
        <div class="entry">
            <p>A few years ago (was it really that long?!), <a href="https://en.wikipedia.org/wiki/User:ClueBot_III">ClueBot III</a> &amp; <a href="https://en.wikipedia.org/wiki/User:ClueBot_NG">ClueBot NG</a> where moved into <a href="https://wikitech.wikimedia.org/wiki/Portal:Wikimedia_Labs">Wikimedia Labs</a> from personal/community servers on <a href="https://www.cluenet.org/">Cluenet</a>.</p>

<p>A while later, they were migrated again from <a href="https://wikitech.wikimedia.org/wiki/Portal:Wikimedia_Labs">Wikimedia Labs</a> into <a href="https://wikitech.wikimedia.org/wiki/Portal:Tool_Labs">Wikimedia Tool Labs</a>, providing more resources via the <a href="http://gridscheduler.sourceforge.net/">Open Grid Manager</a> cluster as well as <a href="https://wikitech.wikimedia.org/wiki/Help:Tool_Labs/Web">web services</a> and other shared community things.</p>

<p>Recently due to <a href="http://releases.ubuntu.com/12.04/">Ubuntu Precise LTS</a> hitting EOL, the <a href="https://wikitech.wikimedia.org/wiki/Portal:Tool_Labs">Tool Labs</a> containers where migrated to run under <a href="http://releases.ubuntu.com/14.04/">Ubuntu Trusty LTS</a>.</p>

<p>During the latest migration, the tool accounts where re-created from scratch. This post will outline how things are configured for a point of reference in the future.</p>

<h1 id="overview">Overview</h1>
<p>Accounts:</p>

<ul>
  <li><code>tools.cluebot</code> - Legacy account - only a web service redirect is running</li>
  <li><code>tools.cluebot3</code> - Dedicated account for <a href="https://en.wikipedia.org/wiki/User:ClueBot_III">ClueBot III</a></li>
  <li><code>tools.cluebotng</code> - Account for all things related to <a href="https://en.wikipedia.org/wiki/User:ClueBot_NG">ClueBot NG</a></li>
</ul>

<p>Databases:</p>

<ul>
  <li><code>s51109__cb</code> - Legacy database, no longer updated</li>
  <li><code>s52585__cb</code> - Migrated database, now master</li>
</ul>

<p>Key Directories/Files:</p>

<p><strong>tools.cluebot3</strong></p>

<ul>
  <li>~/cluebot3 - Clone of <a href="https://github.com/DamianZaremba/cluebot3">https://github.com/DamianZaremba/cluebot3</a></li>
  <li>~/cluebot3/cluebot3.config.php - Config file</li>
  <li>~/.bigbrotherrc - Job Supervisor</li>
</ul>

<p><strong>tools.cluebotng</strong></p>

<ul>
  <li>~/apps/bot - Clone of <a href="https://github.com/DamianZaremba/cluebotng">https://github.com/DamianZaremba/cluebotng</a></li>
  <li>~/apps/report_interface - Clone of <a href="https://github.com/DamianZaremba/cluebotng-report">https://github.com/DamianZaremba/cluebotng-report</a></li>
  <li>~/apps/utils - Clone of <a href="https://github.com/DamianZaremba/cbng-utils">https://github.com/DamianZaremba/cbng-utils</a></li>
  <li>~/apps/core - Downloads of ANN binaries from bintray</li>
  <li>~/public_html - Symlink to ~/apps/report_interface</li>
  <li>~/.cluebotng.password.only - Wikimedia password</li>
  <li>~/.bigbrotherrc - Job Supervisor</li>
  <li>~/mysql_backups - Database dumps</li>
  <li>crontab - Database backup/clean crons</li>
</ul>

<h4 id="hosted-externally">Hosted externally</h4>

<ul>
  <li>check_cluebot3.pl / check_cluebotng.pl - Scripts to check last edit time + email alerts</li>
</ul>

<h1 id="cluebot-iii">ClueBot III</h1>

<h2 id="setup">Setup</h2>

<p>This is a very simple bot, relying on a config file only.</p>

<p>The server-side setup, assuming a clean account can be done following the below (locally):</p>

<ul>
  <li><code>pip install fabric</code></li>
  <li><code>git clone git@github.com:DamianZaremba/cluebot3.git</code></li>
  <li><code>cd cluebot3</code></li>
  <li><code>fab init</code></li>
</ul>

<p>A manual setup is required to create the config file.</p>

<p>This should be created as <code>~/cluebot3/cluebot3.config.php</code> under the tool account, containing the below:</p>

<pre><code class="language-php">&lt;?php
	$owner = 'Cobi';
	$user = 'ClueBot III';
	$pass = 'Clearly this is not the actual password';
	$status = 'rw';
	$maxlag = 2;
	$maxlagkeepgoing = true;
</code></pre>

<p>In your local git clone, you can now do a full deploy (this starts the bot):</p>

<ul>
  <li><code>fab deploy</code></li>
</ul>

<p>Things should be running, check the job status/logs under the tool account to confirm this.</p>

<pre><code class="language-bash">tools.cluebot3@tools-bastion-03:~$ qstat
job-ID  prior   name       user         state submit/start at     queue                          slots ja-task-ID
-----------------------------------------------------------------------------------------------------------------
xxxxxxx 0.30169 cluebot3   tools.cluebo r     03/04/2017 10:23:33 continuous@tools-exec-xxxx.eqi     1

tools.cluebot3@tools-bastion-03:~$ tail -f ~/logs/cluebot3-2017-03-05.log
cluebot3.INFO: doarchive(xxxxxxxxxxxx) [] []
</code></pre>

<p>You should also see <a href="https://en.wikipedia.org/wiki/Special:Contributions/ClueBot_III">edits</a> from the bot after a while (a number of index pages need to be checked first).</p>

<h2 id="debugging">Debugging</h2>

<p>The main bot log is normally somewhat insightful. Sometimes the bot will die due to memory usage when processing large pages,
this generally isn’t seen in the logs and is hard to replicate running manually; looking for restarts is an indicator.</p>

<h1 id="cluebot-ng">ClueBot NG</h1>

<p>This bot is slightly more complicated and has numerous parts. The main part is fully scripted, but a number of (non-obvious) configs need to be in place.</p>

<h2 id="architecture">Architecture</h2>

<p>This is not a depiction of request flow, but service dependencies.</p>

<div class="graphviz-wrapper">

<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: layer 1 encryption Pages: 1 -->
<svg role="img" aria-label="layer 1 encryption" width="1060pt" height="332pt" viewBox="0.00 0.00 1060.02 332.00">
<title>layer 1 encryption</title>
<desc>digraph &quot;layer 1 encryption&quot; {

&quot;Wikipedia IRC RC Feed&quot; -&gt; &quot;Main BOT&quot; [dir=back];
&quot;Main BOT&quot; -&gt; {&quot;Wikimedia Labs Tools Database&quot;, &quot;Wikipedia Database Replica&quot;, &quot;ANN Core&quot;, &quot;Wikimedia API&quot;, &quot;IRC Relay&quot;}
&quot;Review Interface&quot; -&gt; {&quot;Wikimedia Labs Tools Database&quot;, &quot;Wikimedia API&quot;, &quot;IRC Relay&quot;}
&quot;IRC Relay&quot; -&gt; &quot;ClueNet IRC&quot;;
&quot;ClueNet IRC&quot; -&gt; &quot;Huggle / External Tools&quot; [dir=back];

}</desc>

<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)">
<title>layer 1 encryption</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-328 1056.02,-328 1056.02,4 -4,4" />
<!-- Wikipedia IRC RC Feed -->
<g id="node1" class="node">
<title>Wikipedia IRC RC Feed</title>
<ellipse fill="none" stroke="black" cx="569.29" cy="-306" rx="118.08" ry="18" />
<text text-anchor="middle" x="569.29" y="-302.3" font-family="Times,serif" font-size="14.00">Wikipedia IRC RC Feed</text>
</g>
<!-- Main BOT -->
<g id="node2" class="node">
<title>Main BOT</title>
<ellipse fill="none" stroke="black" cx="569.29" cy="-234" rx="57.39" ry="18" />
<text text-anchor="middle" x="569.29" y="-230.3" font-family="Times,serif" font-size="14.00">Main BOT</text>
</g>
<!-- Wikipedia IRC RC Feed&#45;&gt;Main BOT -->
<g id="edge1" class="edge">
<title>Wikipedia IRC RC Feed&#45;&gt;Main BOT</title>
<path fill="none" stroke="black" d="M569.29,-277.67C569.29,-269.05 569.29,-259.79 569.29,-252.1" />
<polygon fill="black" stroke="black" points="565.79,-277.7 569.29,-287.7 572.79,-277.7 565.79,-277.7" />
</g>
<!-- Wikimedia Labs Tools Database -->
<g id="node3" class="node">
<title>Wikimedia Labs Tools Database</title>
<ellipse fill="none" stroke="black" cx="157.29" cy="-162" rx="157.07" ry="18" />
<text text-anchor="middle" x="157.29" y="-158.3" font-family="Times,serif" font-size="14.00">Wikimedia Labs Tools Database</text>
</g>
<!-- Main BOT&#45;&gt;Wikimedia Labs Tools Database -->
<g id="edge2" class="edge">
<title>Main BOT&#45;&gt;Wikimedia Labs Tools Database</title>
<path fill="none" stroke="black" d="M527.54,-221.57C519.52,-219.57 511.17,-217.61 503.29,-216 425.57,-200.08 337.13,-186.61 269.13,-177.24" />
<polygon fill="black" stroke="black" points="269.2,-173.72 258.82,-175.83 268.25,-180.65 269.2,-173.72" />
</g>
<!-- Wikipedia Database Replica -->
<g id="node4" class="node">
<title>Wikipedia Database Replica</title>
<ellipse fill="none" stroke="black" cx="912.29" cy="-162" rx="139.98" ry="18" />
<text text-anchor="middle" x="912.29" y="-158.3" font-family="Times,serif" font-size="14.00">Wikipedia Database Replica</text>
</g>
<!-- Main BOT&#45;&gt;Wikipedia Database Replica -->
<g id="edge3" class="edge">
<title>Main BOT&#45;&gt;Wikipedia Database Replica</title>
<path fill="none" stroke="black" d="M615.9,-223.49C671.04,-212.23 763.81,-193.3 830.89,-179.61" />
<polygon fill="black" stroke="black" points="831.91,-182.98 841.01,-177.55 830.51,-176.12 831.91,-182.98" />
</g>
<!-- ANN Core -->
<g id="node5" class="node">
<title>ANN Core</title>
<ellipse fill="none" stroke="black" cx="696.29" cy="-162" rx="57.69" ry="18" />
<text text-anchor="middle" x="696.29" y="-158.3" font-family="Times,serif" font-size="14.00">ANN Core</text>
</g>
<!-- Main BOT&#45;&gt;ANN Core -->
<g id="edge4" class="edge">
<title>Main BOT&#45;&gt;ANN Core</title>
<path fill="none" stroke="black" d="M596.53,-217.98C615.11,-207.74 639.92,-194.07 660.15,-182.92" />
<polygon fill="black" stroke="black" points="662.02,-185.88 669.09,-177.99 658.64,-179.75 662.02,-185.88" />
</g>
<!-- Wikimedia API -->
<g id="node6" class="node">
<title>Wikimedia API</title>
<ellipse fill="none" stroke="black" cx="411.29" cy="-162" rx="78.79" ry="18" />
<text text-anchor="middle" x="411.29" y="-158.3" font-family="Times,serif" font-size="14.00">Wikimedia API</text>
</g>
<!-- Main BOT&#45;&gt;Wikimedia API -->
<g id="edge5" class="edge">
<title>Main BOT&#45;&gt;Wikimedia API</title>
<path fill="none" stroke="black" d="M537.31,-218.83C513.62,-208.34 481.06,-193.91 454.97,-182.35" />
<polygon fill="black" stroke="black" points="456.24,-179.09 445.68,-178.24 453.4,-185.49 456.24,-179.09" />
</g>
<!-- IRC Relay -->
<g id="node7" class="node">
<title>IRC Relay</title>
<ellipse fill="none" stroke="black" cx="564.29" cy="-162" rx="56.59" ry="18" />
<text text-anchor="middle" x="564.29" y="-158.3" font-family="Times,serif" font-size="14.00">IRC Relay</text>
</g>
<!-- Main BOT&#45;&gt;IRC Relay -->
<g id="edge6" class="edge">
<title>Main BOT&#45;&gt;IRC Relay</title>
<path fill="none" stroke="black" d="M568.05,-215.7C567.5,-207.98 566.84,-198.71 566.22,-190.11" />
<polygon fill="black" stroke="black" points="569.71,-189.83 565.51,-180.1 562.73,-190.33 569.71,-189.83" />
</g>
<!-- ClueNet IRC -->
<g id="node9" class="node">
<title>ClueNet IRC</title>
<ellipse fill="none" stroke="black" cx="564.29" cy="-90" rx="68.79" ry="18" />
<text text-anchor="middle" x="564.29" y="-86.3" font-family="Times,serif" font-size="14.00">ClueNet IRC</text>
</g>
<!-- IRC Relay&#45;&gt;ClueNet IRC -->
<g id="edge10" class="edge">
<title>IRC Relay&#45;&gt;ClueNet IRC</title>
<path fill="none" stroke="black" d="M564.29,-143.7C564.29,-135.98 564.29,-126.71 564.29,-118.11" />
<polygon fill="black" stroke="black" points="567.79,-118.1 564.29,-108.1 560.79,-118.1 567.79,-118.1" />
</g>
<!-- Review Interface -->
<g id="node8" class="node">
<title>Review Interface</title>
<ellipse fill="none" stroke="black" cx="405.29" cy="-234" rx="89.08" ry="18" />
<text text-anchor="middle" x="405.29" y="-230.3" font-family="Times,serif" font-size="14.00">Review Interface</text>
</g>
<!-- Review Interface&#45;&gt;Wikimedia Labs Tools Database -->
<g id="edge7" class="edge">
<title>Review Interface&#45;&gt;Wikimedia Labs Tools Database</title>
<path fill="none" stroke="black" d="M355.7,-219C317.75,-208.29 265.04,-193.41 223.49,-181.69" />
<polygon fill="black" stroke="black" points="224.3,-178.28 213.72,-178.93 222.4,-185.01 224.3,-178.28" />
</g>
<!-- Review Interface&#45;&gt;Wikimedia API -->
<g id="edge8" class="edge">
<title>Review Interface&#45;&gt;Wikimedia API</title>
<path fill="none" stroke="black" d="M406.77,-215.7C407.43,-207.98 408.22,-198.71 408.96,-190.11" />
<polygon fill="black" stroke="black" points="412.45,-190.37 409.82,-180.1 405.48,-189.77 412.45,-190.37" />
</g>
<!-- Review Interface&#45;&gt;IRC Relay -->
<g id="edge9" class="edge">
<title>Review Interface&#45;&gt;IRC Relay</title>
<path fill="none" stroke="black" d="M440.57,-217.46C464.99,-206.71 497.57,-192.37 523.17,-181.1" />
<polygon fill="black" stroke="black" points="524.86,-184.18 532.6,-176.95 522.04,-177.77 524.86,-184.18" />
</g>
<!-- Huggle / External Tools -->
<g id="node10" class="node">
<title>Huggle / External Tools</title>
<ellipse fill="none" stroke="black" cx="564.29" cy="-18" rx="120.48" ry="18" />
<text text-anchor="middle" x="564.29" y="-14.3" font-family="Times,serif" font-size="14.00">Huggle / External Tools</text>
</g>
<!-- ClueNet IRC&#45;&gt;Huggle / External Tools -->
<g id="edge11" class="edge">
<title>ClueNet IRC&#45;&gt;Huggle / External Tools</title>
<path fill="none" stroke="black" d="M564.29,-61.67C564.29,-53.05 564.29,-43.79 564.29,-36.1" />
<polygon fill="black" stroke="black" points="560.79,-61.7 564.29,-71.7 567.79,-61.7 560.79,-61.7" />
</g>
</g>
</svg>
</div>

<p>Critical services for basic bot functionality include:</p>

<ul>
  <li>Wikipedia API (For downloading changes + reverts)</li>
  <li>Tools DB (For creating vandalism IDs + recording action)</li>
  <li>Wikipedia DB Replicas (up to date) (For fetching extra metadata)</li>
  <li>Wikipedia IRC RC Feed (For the change feed)</li>
  <li>Main Bot (Processor)</li>
  <li>Core (For edit scoring)</li>
</ul>

<h2 id="setup-1">Setup</h2>

<p>The server-side setup, assuming a clean account can be done following the below (locally):</p>

<ul>
  <li><code>pip install fabric</code></li>
  <li><code>git clone git@github.com:DamianZaremba/cluebotng.git</code></li>
  <li><code>cd cluebotng</code></li>
  <li><code>fab deploy</code></li>
</ul>

<h3 id="config-files">Config Files</h3>

<p>A number of config files need to be created manually.</p>

<h4 id="cluebotngpasswordonly">~/.cluebotng.password.only</h4>

<pre><code class="language-plain">The Wikipedia ClueBot NG user password
</code></pre>

<h4 id="appsbotbotcluebot-ngconfigphp">~/apps/bot/bot/cluebot-ng.config.php</h4>

<pre><code class="language-php">&lt;?php
namespace CluebotNG;

class Config
{
    public static $user = 'ClueBot NG';
    public static $pass = null;
    public static $status = 'auto';
    public static $angry = false;
    public static $owner = 'Cobi';
    public static $friends = 'ClueBot,DASHBotAV';
    public static $mw_mysql_host = 'enwiki.labsdb';
    public static $mw_mysql_port = 3306;
    public static $mw_mysql_user = 's52585';
    public static $mw_mysql_pass = 'a password that is actually real';
    public static $mw_mysql_db = 'enwiki_p';
    public static $legacy_mysql_host = 'tools-db';
    public static $legacy_mysql_port = 3306;
    public static $legacy_mysql_user = 's52585';
    public static $legacy_mysql_pass = 'a password that is actually real';
    public static $legacy_mysql_db = 's52585__cb';
    public static $cb_mysql_host = 'tools-db';
    public static $cb_mysql_port = 3306;
    public static $cb_mysql_user = 's52585';
    public static $cb_mysql_pass = 'a password that is actually real';
    public static $cb_mysql_db = 's52585__cb';
    public static $udpport = 3334;
    public static $coreport = 3565;
    public static $fork = true;
    public static $dry = false;
    public static $sentry_url = null;
}
</code></pre>

<h4 id="appsreport_interfaceweb-settingsphp">~/apps/report_interface/web-settings.php</h4>

<pre><code class="language-php">&lt;?PHP
	$dbHost = 'tools-db';
	$dbUser = 's52585';
	$dbPass = 'a password that is actually real';
	$dbSchema = 's52585__cb';
	$rcport = 3333;
	$recaptcha_pubkey = "something here";
	$recaptcha_privkey = "something here too";
</code></pre>

<h4 id="appsbotrelay_ircrelay_ircconfjs">~/apps/bot/relay_irc/relay_irc.conf.js</h4>

<pre><code class="language-javascript">exports.nick = 'CBNGRelay';
exports.server = 'irc.cluenet.org';
exports.extra = [
    'OPER antiflood This Is Not The One You Are Looking For',
];
</code></pre>

<h3 id="re-deploy">Re-Deploy</h3>

<p>Now the config files are in place, the bot should actually work.</p>

<p>In your local git clone, complete another deploy, to restart everything:</p>

<ul>
  <li><code>fab deploy</code></li>
</ul>

<h3 id="bot-checks">Bot Checks</h3>

<h5 id="first-check-the-job-status">First, check the job status</h5>

<pre><code class="language-bash">tools.cluebotng@tools-bastion-03:~$ qstat
job-ID  prior   name       user         state submit/start at     queue                          slots ja-task-ID
-----------------------------------------------------------------------------------------------------------------
xxxxxxx 0.30159 lighttpd-c tools.cluebo r     03/04/2017 12:48:57 webgrid-lighttpd@tools-webgrid     1
xxxxxxx 0.30154 cbng_relay tools.cluebo r     03/04/2017 13:32:09 continuous@tools-exec-xxxx.too     1
xxxxxxx 0.30154 cbng_core  tools.cluebo r     03/04/2017 13:32:11 continuous@tools-exec-xxxx.too     1
xxxxxxx 0.30092 cbng_bot   tools.cluebo r     03/04/2017 23:56:38 continuous@tools-exec-xxxx.too     1
</code></pre>

<h5 id="next-check-the-bot-logs">Next check the bot logs</h5>

<pre><code>tools.cluebotng@tools-bastion-03:~$ tail -f ~/logs/cluebotng-2017-03-05.log
cluebotng.INFO: Processing: [[Something]] [...]
</code></pre>

<h5 id="then-check-the-irc-feeds-irccluenetorg">Then check the IRC Feeds (irc.cluenet.org)</h5>

<ul>
  <li><code>#cluebotng-spam</code> - Should have constant messages</li>
  <li><code>#wikipedia-VAN</code> - Should have a message within 10min</li>
</ul>

<p>Confirm the bot is also <a href="https://en.wikipedia.org/wiki/Special:Contributions/ClueBot_NG">making edits</a> inline with messages reported in <code>#wikipedia-VAN</code>.</p>

<h5 id="finally-check-the-review-interface">Finally, check the review interface</h5>

<ul>
  <li><a href="https://tools.wmflabs.org/cluebotng/?page=List">https://tools.wmflabs.org/cluebotng/?page=List</a> - Should render</li>
  <li><a href="https://tools.wmflabs.org/cluebotng/?page=View&amp;id=120371">https://tools.wmflabs.org/cluebotng/?page=View&amp;id=120371</a> - Should render</li>
  <li>Take a recent edit from the <code>#wikipedia-VAN</code> channel and submit it as a reported</li>
  <li>Check Sign In works (set your test above to invalid, if it looks OK)</li>
</ul>

<h3 id="general-checks">General Checks</h3>

<p>After a couple of hours, check:</p>

<ul>
  <li>check_cluebot3.pl / check_cluebotng.pl are successfully running externally</li>
  <li>~/mysql_backups/ contains valid database dumps</li>
  <li>No ‘not running’ emails have been received</li>
  <li>~/bigbrother.log for restarts</li>
  <li><a href="https://en.wikipedia.org/wiki/User_talk:ClueBot_Commons">ClueBot Commons</a> For user problems</li>
</ul>

<h2 id="debugging-1">Debugging</h2>

<p>The main bot log provides a good indicator as to the source of problems but has limited data due to the logging volume.</p>

<p>It is common to see ‘Failed to get edit data for xxx’, this is only a problem if it’s happening for a large number of changes; normally this is due to delayed replicas, causing the user/page metadata for new users/pages to be non-existent.</p>

<p>The relays generally don’t break but may have incorrect entries in the database. The simplest fix is to kill the job and let it re-spawn.</p>

<p>The report interface will likely break due to PHP being updated, it will need fixing randomly; there is a motivation to rebuild the interface to include the review functionality as well as OAuth based authentication (<a href="https://phabricator.wikimedia.org/T135323">T135323</a>).</p>

        </div>
    </article>
    



<nav id="page_nav">
    

    
    <a href="/2/" class="next">Next Page &raquo;</a>
    
</nav>


    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <p class="text-muted">Copyright 2009-2022 <a href="http://damianzaremba.co.uk">Damian Zaremba</a></p>
        <ul id="ads">
          <li>Need error tracking? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li>
          <li>Need cloud instances? Jump on <a href="http://www.bigv.io">BigV</a></li>
          <li>Want my website? <a href="https://github.com/DamianZaremba/damianzaremba.co.uk/">Source</a></li>
        </ul>
      </div>
    </footer>

    <!-- JS scripts -->
    <script src="/assests/js/jquery.min.js"></script>
    <script src="/assests/js/bootstrap.min.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_require', 'inpage_linkid', '//www.google-analytics.com/plugins/ga/inpage_linkid.js']);
      _gaq.push(['_setAccount', 'UA-11817192-1']);
      _gaq.push(['_setDomainName', 'damianzaremba.co.uk']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = '//stats.g.doubleclick.net/dc.js'
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();

      (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//damianzaremba.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>

    <!--[if lt IE 9]>
      <script src="/assests/js/html5shiv.min.js"></script>
      <script src="/assests/js/respond.min.js"></script>
    <![endif]-->
  </body>
</html>
